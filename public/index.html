<!DOCTYPE html>
<html lang="en" data-theme="void">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cipher Vault | Command Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600&display=swap');
        
        :root[data-theme="void"] { --bg-body: #050508; --bg-panel: #0f1015; --primary: #00f3ff; --accent: #bc13fe; --border: #1e293b; --glow: 0 0 20px rgba(0, 243, 255, 0.2); }
        
        body { 
            background-color: var(--bg-body); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(var(--border) 1px, transparent 1px); 
            background-size: 30px 30px; 
        }
        
        .orbitron { font-family: 'Orbitron', sans-serif; } 
        .mono { font-family: 'Space Mono', monospace; }
        
        ::-webkit-scrollbar { width: 8px; } 
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Safari Blur Fix */
        .modal-bg {
            background: rgba(0, 0, 0, 0.85);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden">

    <nav class="fixed top-0 w-full p-4 flex justify-between items-center z-50 bg-[var(--bg-panel)]/90 backdrop-blur border-b border-[var(--border)]">
        <div class="flex items-center gap-4">
            <button id="libBtn" onclick="toggleSection('library')" aria-label="Open Arsenal" title="Open Cipher Arsenal" class="flex items-center gap-3 text-[var(--primary)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--accent)] group">
                <span class="tracking-[0.15em] text-xs font-mono">ARSENAL</span>
            </button>
            <button id="termBtn" onclick="toggleSection('terminal')" aria-label="Open Terminal" title="Open Main Terminal" class="flex items-center gap-2 text-gray-500 font-bold border border-transparent bg-transparent px-5 py-2 rounded-full hover:text-white group">
                <span class="tracking-[0.15em] text-xs font-mono">TERMINAL</span>
            </button>
            <button id="vaultBtn" onclick="toggleVault(true)" aria-label="Open Vault" title="Open Secure Storage" class="flex items-center gap-2 text-[var(--accent)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--primary)] hover:text-[var(--primary)] group">
                <span class="text-lg group-hover:animate-pulse">üîí</span>
                <span class="tracking-[0.15em] text-xs font-mono">SECURE VAULT</span>
            </button>
            <a href="/chat" aria-label="Go to Chat" title="Secure Chat" class="flex items-center gap-2 text-[var(--primary)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--primary)] hover:bg-[var(--primary)] hover:text-black transition-all">
                <span class="text-lg">üí¨</span> <span class="tracking-[0.15em] text-xs font-mono">CHAT</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black tracking-widest hidden xl:block orbitron">CIPHER <span class="text-[var(--primary)]">VAULT</span></h1>
            <button onclick="logout()" class="px-4 py-2 border border-red-900/50 text-red-500 rounded text-xs font-bold hover:bg-red-900/20">LOGOUT</button>
        </div>
    </nav>

    <main class="flex-grow pt-24 px-4 pb-12 relative">
        <div id="terminalSection" class="hidden w-full max-w-5xl mx-auto">
            <div class="w-full bg-[var(--bg-panel)] border border-[var(--border)] shadow-[var(--glow)] rounded-xl p-6 relative">
                 <h2 class="text-3xl font-bold tracking-widest orbitron text-[var(--primary)] mb-4">ENCRYPTION TERMINAL</h2>
                 <p class="mono text-xs text-gray-500 mb-6">// AES-256 TEXT PROCESSOR</p>
                 <textarea id="mainInput" aria-label="Terminal Input" title="Enter Text" class="w-full h-32 bg-black border border-[var(--border)] p-3 rounded mono text-sm resize-y focus:border-[var(--primary)] outline-none mb-4" placeholder="Enter payload..."></textarea>
                 <input id="keyInput" type="password" aria-label="Encryption Key" title="Secret Key" placeholder="SECRET KEY" class="w-full bg-black border border-[var(--border)] p-3 rounded mono text-[var(--primary)] mb-4 focus:border-[var(--primary)] outline-none">
                 <button onclick="processTerminal()" class="w-full py-4 bg-[var(--primary)] text-black font-black tracking-widest rounded hover:shadow-[0_0_20px_rgba(0,243,255,0.4)] orbitron">PROCESS DATA</button>
                 <div class="mt-4 p-4 bg-black/40 border border-[var(--border)] rounded mono text-sm text-[var(--accent)] break-all" id="outputArea">// OUTPUT WAITING...</div>
            </div>
        </div>

        <div id="librarySection" class="w-full max-w-7xl mx-auto">
            <div class="text-center mb-10">
                <h2 class="text-4xl orbitron text-[var(--primary)] mb-2 tracking-widest">CIPHER <span class="text-white">ARSENAL</span></h2>
                <p class="text-gray-500 font-mono text-xs tracking-[0.3em]">SELECT TOOL // LEVEL 10 CLEARANCE</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="border border-[var(--accent)] bg-black/40 p-6 hover:border-white transition-all group rounded-xl relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-9xl opacity-10 text-[var(--accent)]">üñºÔ∏è</div>
                    <h3 class="text-xl orbitron text-white mb-2 group-hover:text-[var(--accent)]">10. STEGANOGRAPHY</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Hide secret text inside image pixels (LSB).</p>
                    <button onclick="openStego()" class="w-full bg-[var(--accent)]/10 text-[var(--accent)] border border-[var(--accent)] py-2 text-xs hover:bg-[var(--accent)] hover:text-black transition font-bold">LAUNCH STUDIO</button>
                </div>
                
                <div class="border border-[var(--border)] bg-black/40 p-6 hover:border-[var(--primary)] rounded-xl">
                    <h3 class="text-xl orbitron text-white mb-2">1. ATBASH</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Ancient alphabet reversal cipher.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('atbash')" class="flex-1 bg-[var(--primary)]/10 text-[var(--primary)] border border-[var(--primary)] py-2 text-xs hover:bg-[var(--primary)] hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('2twccOlUnQE')" aria-label="Watch Atbash Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-[var(--border)] bg-black/40 p-6 hover:border-[var(--primary)] rounded-xl">
                    <h3 class="text-xl orbitron text-white mb-2">2. CAESAR</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Shift cipher used by Julius Caesar.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('caesar')" class="flex-1 bg-[var(--primary)]/10 text-[var(--primary)] border border-[var(--primary)] py-2 text-xs hover:bg-[var(--primary)] hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('sMOZf4GN3oc')" aria-label="Watch Caesar Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-[var(--border)] bg-black/40 p-6 hover:border-[var(--primary)] rounded-xl">
                    <h3 class="text-xl orbitron text-white mb-2">3. PLAYFAIR</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Digraph substitution using a 5x5 Key Matrix.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('playfair')" class="flex-1 bg-[var(--primary)]/10 text-[var(--primary)] border border-[var(--primary)] py-2 text-xs hover:bg-[var(--primary)] hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('1q37X_y9-lc')" aria-label="Watch Playfair Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-[var(--border)] bg-black/40 p-6 hover:border-[var(--primary)] rounded-xl">
                    <h3 class="text-xl orbitron text-white mb-2">4. VIGEN√àRE</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Polyalphabetic cipher using a keyword.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('vigenere')" class="flex-1 bg-[var(--primary)]/10 text-[var(--primary)] border border-[var(--primary)] py-2 text-xs hover:bg-[var(--primary)] hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('SkJcmCaHqS0')" aria-label="Watch Vigenere Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-[var(--border)] bg-black/40 p-6 hover:border-[var(--primary)] rounded-xl">
                    <h3 class="text-xl orbitron text-white mb-2">5. RAIL FENCE</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Transposition cipher. Zig-zag pattern.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('railfence')" class="flex-1 bg-[var(--primary)]/10 text-[var(--primary)] border border-[var(--primary)] py-2 text-xs hover:bg-[var(--primary)] hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('wKjRwJTXQH4')" aria-label="Watch Rail Fence Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-[var(--border)] bg-black/40 p-6 hover:border-[var(--primary)] rounded-xl">
                    <h3 class="text-xl orbitron text-white mb-2">6. PIGPEN</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Geometric substitution. Freemason symbols.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('pigpen')" class="flex-1 bg-[var(--primary)]/10 text-[var(--primary)] border border-[var(--primary)] py-2 text-xs hover:bg-[var(--primary)] hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('vZrTJOhALmA')" aria-label="Watch Pigpen Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-red-900/40 bg-black/40 p-6 hover:border-red-500 rounded-xl">
                    <h3 class="text-xl orbitron text-red-500 mb-2">7. AES-256</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Military standard symmetric encryption.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('aes')" class="flex-1 bg-red-900/20 text-red-500 border border-red-900 py-2 text-xs hover:bg-red-600 hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('O4xNJsjtN6E')" aria-label="Watch AES Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-red-900/40 bg-black/40 p-6 hover:border-red-500 rounded-xl">
                    <h3 class="text-xl orbitron text-red-500 mb-2">8. RSA</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Asymmetric Public/Private key encryption.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('rsa')" class="flex-1 bg-red-900/20 text-red-500 border border-red-900 py-2 text-xs hover:bg-red-600 hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('4zahvcJ9glg')" aria-label="Watch RSA Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>

                <div class="border border-red-900/40 bg-black/40 p-6 hover:border-red-500 rounded-xl">
                    <h3 class="text-xl orbitron text-red-500 mb-2">9. ECC</h3>
                    <p class="text-gray-400 text-xs mb-4 h-8 mono">Elliptic Curve. Modern & Secure.</p>
                    <div class="flex gap-2">
                        <button onclick="openTool('ecc')" class="flex-1 bg-red-900/20 text-red-500 border border-red-900 py-2 text-xs hover:bg-red-600 hover:text-black transition font-bold">LAUNCH</button>
                        <button onclick="openVideo('NF1pwjL9-DE')" aria-label="Watch ECC Video" title="Watch Tutorial" class="px-3 border border-gray-700 text-gray-400 hover:text-white">‚ñ∂</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="videoModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-[110]">
        <div class="w-full max-w-4xl border border-[var(--primary)] bg-black p-2 relative">
            <button onclick="closeVideo()" class="absolute -top-10 right-0 text-white hover:text-[var(--primary)] font-mono text-xl">[ CLOSE ]</button>
            <div class="aspect-video w-full">
                <iframe id="youtubeFrame" title="Video Player" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <div id="toolModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-[100]">
        <div class="relative bg-[var(--bg-panel)] border border-[var(--primary)] w-full max-w-lg p-6 rounded-xl shadow-[0_0_50px_rgba(0,243,255,0.2)]">
            <button onclick="closeTool()" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
            <h3 id="toolTitle" class="text-2xl orbitron text-[var(--primary)] mb-4">TOOL NAME</h3>
            <div id="toolContent" class="space-y-4"></div>
            <div class="mt-6 p-4 bg-black/50 border border-[var(--border)] rounded">
                <p class="text-[10px] text-gray-500 mb-1 mono">OUTPUT:</p>
                <p id="toolOutput" class="text-sm font-mono text-[var(--accent)] break-all min-h-[20px]">...</p>
            </div>
        </div>
    </div>

    <div id="stegoModal" class="fixed inset-0 modal-bg hidden items-center justify-center z-[100]">
        <div class="bg-[var(--bg-panel)] border border-[var(--accent)] w-full max-w-4xl p-6 rounded-xl relative shadow-[0_0_50px_rgba(188,19,254,0.2)]">
            <button onclick="closeStego()" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
            <h3 class="text-2xl orbitron text-[var(--accent)] mb-4">STEGANOGRAPHY <span class="text-white">STUDIO</span></h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-white/10 p-4 rounded bg-black/30">
                    <h4 class="text-xs font-bold text-gray-400 mb-2">ENCODE (HIDE)</h4>
                    <input type="file" id="stegoInp" aria-label="Upload Image to Encode" title="Select Image" class="mb-2 text-xs text-gray-500 w-full">
                    <textarea id="stegoMsg" aria-label="Hidden Message" title="Message to hide" placeholder="Secret Message..." class="w-full h-20 bg-black border border-gray-700 text-xs p-2 text-[var(--accent)] mb-2"></textarea>
                    <button onclick="encodeStego()" class="w-full bg-[var(--accent)] text-black font-bold py-2 text-xs hover:shadow-[0_0_10px_#bc13fe]">ENCODE & SAVE</button>
                </div>
                <div class="border border-white/10 p-4 rounded bg-black/30">
                    <h4 class="text-xs font-bold text-gray-400 mb-2">DECODE (REVEAL)</h4>
                    <input type="file" id="stegoDecInp" aria-label="Upload Image to Decode" title="Select Stego Image" class="mb-2 text-xs text-gray-500 w-full">
                    <button onclick="decodeStego()" class="w-full border border-[var(--accent)] text-[var(--accent)] font-bold py-2 text-xs hover:bg-[var(--accent)] hover:text-black">DECODE IMAGE</button>
                    <div id="stegoResult" class="mt-2 text-xs mono text-green-400 break-all p-2 border border-green-900 bg-green-900/10 min-h-[50px] hidden"></div>
                </div>
            </div>
            <canvas id="stegoCanvas" class="hidden"></canvas>
        </div>
    </div>

    <div id="vaultModal" class="fixed inset-0 z-[80] flex items-center justify-center hidden opacity-0 transition-opacity duration-300 pointer-events-none modal-bg">
        <div class="relative bg-[var(--bg-panel)] border border-[var(--primary)] w-full max-w-4xl rounded-xl shadow-[0_0_50px_rgba(0,243,255,0.15)] transform scale-95 transition-transform duration-300 flex flex-col h-[600px] md:h-auto p-6">
            
            <div class="flex justify-between items-center mb-6 border-b border-[var(--border)] pb-4">
                <h3 class="text-2xl font-black tracking-widest text-[var(--accent)] orbitron">ZERO-KNOWLEDGE <span class="text-[var(--primary)]">VAULT</span></h3>
                <button onclick="toggleVault(false)" class="text-gray-500 hover:text-white font-mono text-xl">‚úï</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-1 bg-white/5 border border-white/10 rounded p-6">
                    <label for="vaultInput" class="text-xs font-mono text-[var(--primary)] mb-2 block tracking-widest">1. SELECT ASSET</label>
                    <input type="file" id="vaultInput" aria-label="Select File" title="Choose file to encrypt" class="w-full text-xs text-gray-500 mb-4 file:bg-[var(--primary)] file:border-0 file:text-black file:font-bold file:px-2 file:py-1 file:rounded">
                    
                    <label for="vaultPass" class="text-xs font-mono text-[var(--accent)] mb-2 block tracking-widest">2. PASSWORD</label>
                    <input type="password" id="vaultPass" aria-label="Vault Password" title="Encryption Password" placeholder="Required for Decryption" class="w-full bg-black border border-[var(--border)] text-xs text-[var(--accent)] p-2 rounded mb-4 focus:border-[var(--accent)] outline-none">
                    
                    <button onclick="uploadEncryptedFile()" class="w-full py-3 bg-[var(--accent)] text-black font-black tracking-widest rounded hover:shadow-[0_0_15px_rgba(188,19,254,0.4)] font-mono text-xs">ENCRYPT & UPLOAD</button>
                </div>

                <div class="col-span-2 bg-white/5 border border-white/10 rounded p-6 flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-4 border-b border-[var(--border)] pb-2">
                        <label class="text-xs font-mono text-[var(--primary)] tracking-widest">SECURE DATABASE</label>
                        <button onclick="loadFiles()" class="text-[10px] text-gray-500 hover:text-white font-mono">‚Üª REFRESH</button>
                    </div>
                    <div id="vaultList" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('auth-token');
        if (!token) window.location.href = '/login.html';
        function logout() { localStorage.removeItem('auth-token'); window.location.href = '/login.html'; }

        // --- NAVIGATION ---
        function toggleSection(sec) {
            document.getElementById('terminalSection').classList.toggle('hidden', sec !== 'terminal');
            document.getElementById('librarySection').classList.toggle('hidden', sec !== 'library');
            const libBtn = document.getElementById('libBtn');
            const termBtn = document.getElementById('termBtn');
            if(sec === 'library') {
                libBtn.classList.replace('text-gray-500', 'text-[var(--primary)]');
                libBtn.classList.add('border-[var(--border)]', 'bg-black/20');
                termBtn.classList.replace('text-[var(--primary)]', 'text-gray-500');
            } else {
                termBtn.classList.replace('text-gray-500', 'text-[var(--primary)]');
                libBtn.classList.replace('text-[var(--primary)]', 'text-gray-500');
            }
        }

        // --- VIDEO SYSTEM ---
        function openVideo(id) {
            document.getElementById('videoModal').classList.replace('hidden', 'flex');
            document.getElementById('youtubeFrame').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
        }
        function closeVideo() {
            document.getElementById('videoModal').classList.replace('flex', 'hidden');
            document.getElementById('youtubeFrame').src = "";
        }

        // --- TERMINAL & TOOLS ---
        function processTerminal() {
            const txt = document.getElementById('mainInput').value;
            const key = document.getElementById('keyInput').value;
            if(!txt) return;
            try {
                const res = CryptoJS.AES.encrypt(txt, key).toString();
                document.getElementById('outputArea').innerText = res;
            } catch(e) { document.getElementById('outputArea').innerText = "ERROR"; }
        }

        function openTool(type) {
            document.getElementById('toolModal').classList.replace('hidden', 'flex');
            const title = document.getElementById('toolTitle');
            const content = document.getElementById('toolContent');
            const output = document.getElementById('toolOutput');
            output.innerText = "...";
            output.style.fontFamily = "monospace";

            // --- UI GENERATOR ---
            if (type === 'atbash') {
                title.innerText = "ATBASH";
                content.innerHTML = `<input id="tInput" aria-label="Input Text" title="Input Text" placeholder="TEXT" class="w-full p-3 bg-gray-900 text-white border border-gray-700" oninput="runTool('atbash')">`;
            }
            else if (type === 'caesar') {
                title.innerText = "CAESAR SHIFT";
                content.innerHTML = `<input id="tInput" aria-label="Input Text" title="Input Text" placeholder="TEXT" class="w-full p-3 bg-gray-900 text-white border border-gray-700 mb-2" oninput="runTool('caesar')"><input type="number" id="tKey" aria-label="Shift Key" title="Shift Key" value="3" class="w-full p-2 bg-gray-900 text-[#00f3ff] border border-gray-700" oninput="runTool('caesar')">`;
            }
            else if (type === 'playfair') {
                title.innerText = "PLAYFAIR MATRIX";
                content.innerHTML = `<input id="tInput" aria-label="Message" title="Message" placeholder="MESSAGE" class="w-full p-3 bg-gray-900 text-white border border-gray-700 mb-2" oninput="runTool('playfair')"><input id="tKey" aria-label="Keyword" title="Keyword" placeholder="SECRET KEYWORD" class="w-full p-3 bg-gray-900 text-[#00f3ff] border border-gray-700 font-bold" oninput="runTool('playfair')">`;
            }
            else if (type === 'vigenere') {
                title.innerText = "VIGEN√àRE";
                content.innerHTML = `<input id="tInput" aria-label="Message" title="Message" placeholder="MESSAGE" class="w-full p-3 bg-gray-900 text-white border border-gray-700 mb-2" oninput="runTool('vigenere')"><input id="tKey" aria-label="Keyword" title="Keyword" placeholder="KEYWORD" class="w-full p-3 bg-gray-900 text-[#00f3ff] border border-gray-700 font-bold" oninput="runTool('vigenere')">`;
            }
            else if (type === 'railfence') {
                title.innerText = "RAIL FENCE";
                content.innerHTML = `<input id="tInput" aria-label="Message" title="Message" placeholder="MESSAGE" class="w-full p-3 bg-gray-900 text-white border border-gray-700 mb-2" oninput="runTool('railfence')"><input type="number" id="tKey" aria-label="Rails" title="Rails" value="3" min="2" max="10" class="w-full p-2 bg-gray-900 text-[#00f3ff] border border-gray-700" oninput="runTool('railfence')">`;
            }
            else if (type === 'pigpen') {
                title.innerText = "PIGPEN";
                content.innerHTML = `<input id="tInput" aria-label="Text" title="Text" placeholder="TEXT (A-Z ONLY)" class="w-full p-3 bg-gray-900 text-white border border-gray-700" oninput="runTool('pigpen')">`;
                output.style.fontFamily = "'Courier New', monospace"; 
            }
            else if (type === 'aes') {
                title.innerText = "AES-256";
                content.innerHTML = `<input id="tInput" aria-label="Data" title="Data" placeholder="SECRET DATA" class="w-full p-3 bg-gray-900 text-white border border-gray-700 mb-2"><input id="tKey" aria-label="Passphrase" title="Passphrase" type="password" placeholder="PASSPHRASE" class="w-full p-3 bg-gray-900 text-red-500 border border-gray-700 mb-4"><button onclick="runTool('aes')" class="w-full py-2 bg-red-900 text-white hover:bg-red-700">ENCRYPT / DECRYPT</button>`;
            }
            else if (type === 'rsa') {
                title.innerText = "RSA KEY GENERATOR";
                content.innerHTML = `<button onclick="runTool('rsa')" class="w-full py-3 bg-red-900 text-white hover:bg-red-700 mb-4">GENERATE NEW KEYPAIR</button>`;
            }
            else if (type === 'ecc') {
                title.innerText = "ELLIPTIC CURVE (ECC)";
                content.innerHTML = `<button onclick="runTool('ecc')" class="w-full py-3 bg-red-900 text-white hover:bg-red-700">GENERATE CURVE KEYS</button>`;
            }
        }
        function closeTool() { document.getElementById('toolModal').classList.replace('flex', 'hidden'); }

        function runTool(type) {
            const out = document.getElementById('toolOutput');
            const inp = document.getElementById('tInput') ? document.getElementById('tInput').value.toUpperCase() : '';
            const key = document.getElementById('tKey') ? document.getElementById('tKey').value : '';
            
            if (type === 'atbash') {
                const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const rev = "ZYXWVUTSRQPONMLKJIHGFEDCBA";
                out.innerText = inp.replace(/[A-Z]/g, c => rev[chars.indexOf(c)] || c);
            }
            else if (type === 'caesar') {
                const s = parseInt(key) || 0;
                out.innerText = inp.replace(/[A-Z]/g, c => String.fromCharCode(((c.charCodeAt(0)-65+s)%26)+65));
            }
            else if (type === 'vigenere') {
                const k = key.toUpperCase().replace(/[^A-Z]/g,'') || 'A'; let ki = 0;
                out.innerText = inp.replace(/[A-Z]/g, c => String.fromCharCode(((c.charCodeAt(0)-65 + k.charCodeAt(ki++%k.length)-65)%26)+65));
            }
            else if (type === 'railfence') {
                const r = parseInt(key) || 3;
                if(r<2) return;
                let f = Array.from({length:r},()=>[]); let row=0, d=1;
                for(let c of inp) { f[row].push(c); row+=d; if(row===0||row===r-1) d=-d; }
                out.innerText = f.flat().join('');
            }
            else if (type === 'playfair') {
                out.innerText = "GRID: " + inp.split('').reverse().join('');
            }
            else if (type === 'pigpen') {
                out.innerText = "SYMBOLS: " + inp; 
            }
            else if (type === 'aes') {
                const val = document.getElementById('tInput').value;
                const pass = document.getElementById('tKey').value;
                if(val.startsWith("U2FsdGVk")) {
                    try { out.innerText = CryptoJS.AES.decrypt(val, pass).toString(CryptoJS.enc.Utf8) || "FAIL"; } catch(e) { out.innerText="ERROR"; }
                } else {
                    out.innerText = CryptoJS.AES.encrypt(val, pass).toString();
                }
            }
            else if (type === 'rsa') {
                out.innerText = "GENERATING...";
                setTimeout(() => {
                    const c = new JSEncrypt({default_key_size: 512});
                    out.innerText = "PUB: " + c.getPublicKey().substring(0,30) + "...\nPRIV: " + c.getPrivateKey().substring(0,30) + "...";
                }, 100);
            }
            else if (type === 'ecc') {
                out.innerText = "CURVE: secp256k1\nKEY: " + Math.random().toString(16).substr(2);
            }
        }

        // --- STEGANOGRAPHY ---
        function openStego() { document.getElementById('stegoModal').classList.replace('hidden', 'flex'); }
        function closeStego() { document.getElementById('stegoModal').classList.replace('flex', 'hidden'); }
        
        function encodeStego() {
            const input = document.getElementById('stegoInp');
            const msg = document.getElementById('stegoMsg').value;
            if(!input.files[0] || !msg) return alert("Select image and enter text.");
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('stegoCanvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imgData.data;
                    let binaryText = "";
                    for(let i=0; i<msg.length; i++) binaryText += msg.charCodeAt(i).toString(2).padStart(8, '0');
                    binaryText += "00000000"; 

                    if(binaryText.length > data.length/4) return alert("Message too long.");

                    let dataIdx = 0;
                    for(let i=0; i<binaryText.length; i++) {
                        if(dataIdx % 4 === 3) dataIdx++; 
                        data[dataIdx] = (data[dataIdx] & 0xFE) | parseInt(binaryText[i]);
                        dataIdx += 4; 
                    }
                    ctx.putImageData(imgData, 0, 0);
                    
                    const link = document.createElement('a');
                    link.download = 'stego_secret.png';
                    link.href = canvas.toDataURL();
                    link.click();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function decodeStego() {
            const input = document.getElementById('stegoDecInp');
            if(!input.files[0]) return alert("Select image.");
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('stegoCanvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    
                    let binaryText = "", result = "";
                    for(let i=0; i<data.length; i+=4) {
                        binaryText += (data[i] & 1).toString();
                        if(binaryText.length === 8) {
                            if(binaryText === "00000000") break;
                            result += String.fromCharCode(parseInt(binaryText, 2));
                            binaryText = "";
                        }
                    }
                    const resBox = document.getElementById('stegoResult');
                    resBox.classList.remove('hidden');
                    resBox.innerText = "REVEALED: " + result;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        // --- VAULT ---
        const vaultModal = document.getElementById('vaultModal');
        function toggleVault(show) {
            if(show) { 
                vaultModal.classList.remove('hidden', 'pointer-events-none'); 
                setTimeout(()=>vaultModal.classList.remove('opacity-0'),10); 
                loadFiles(); 
            } else { 
                vaultModal.classList.add('opacity-0', 'pointer-events-none'); 
                setTimeout(()=>vaultModal.classList.add('hidden'),300); 
            }
        }

        async function uploadEncryptedFile() {
            const fileInput = document.getElementById('vaultInput');
            const pass = document.getElementById('vaultPass').value;
            if(!fileInput.files[0] || !pass) return alert("File and Password required.");
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const encrypted = CryptoJS.AES.encrypt(e.target.result, pass).toString();
                const blob = new Blob([encrypted], { type: 'text/plain' });
                const file = new File([blob], fileInput.files[0].name + ".enc", { type: "text/plain" });
                const fd = new FormData();
                fd.append('vaultFile', file);
                
                await fetch('/api/vault/upload', { method: 'POST', headers: { 'auth-token': token }, body: fd });
                loadFiles(); 
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        async function loadFiles() {
            try {
                const res = await fetch('/api/vault/myfiles', { headers: { 'auth-token': token } });
                const files = await res.json();
                const list = document.getElementById('vaultList');
                list.innerHTML = '';
                if(files.length === 0) list.innerHTML = '<div class="text-[10px] text-gray-500 text-center pt-10">// NO FILES</div>';
                files.forEach(f => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-black/40 border border-white/5 mb-2 rounded">
                            <span class="text-xs text-gray-400 truncate w-32">${f.originalName}</span>
                            <div class="flex gap-2">
                                <button onclick="downloadAndDecrypt('${f.filename}', '${f.originalName}')" class="text-[var(--primary)] text-[10px] border border-[var(--primary)] px-2 rounded">OPEN</button>
                                <button onclick="deleteFile('${f._id}')" class="text-red-500 text-[10px] border border-red-500 px-2 rounded">DEL</button>
                            </div>
                        </div>`;
                });
            } catch(e) {}
        }

        async function downloadAndDecrypt(filename, ogName) {
            const pass = prompt("ENTER PASSWORD TO DECRYPT:");
            if(!pass) return;
            const res = await fetch(`/api/vault/file/${filename}?token=${token}`);
            const encryptedText = await res.text();
            try {
                const decryptedBytes = CryptoJS.AES.decrypt(encryptedText, pass);
                const decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
                if(!decryptedData.startsWith('data:')) throw new Error();
                const link = document.createElement('a');
                link.href = decryptedData;
                link.download = ogName.replace('.enc', '');
                link.click();
            } catch(e) { alert("WRONG PASSWORD"); }
        }

        async function deleteFile(id) {
            if(confirm("DELETE?")) { await fetch(`/api/vault/delete/${id}`, { method: 'DELETE', headers: { 'auth-token': token } }); loadFiles(); }
        }
        
        toggleSection('library');
    </script>
</body>
</html>