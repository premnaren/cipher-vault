<!DOCTYPE html>
<html lang="en" data-theme="void">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cipher Vault | Secure Terminal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Rajdhani:wght@500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;900&display=swap');

        :root[data-theme="void"] { --bg-body: #050508; --bg-panel: #0f1015; --primary: #00f3ff; --accent: #bc13fe; --border: #1e293b; --glow: 0 0 20px rgba(0, 243, 255, 0.2); }
        
        body { 
            background-color: var(--bg-body); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(var(--border) 1px, transparent 1px); 
            background-size: 30px 30px;
            /* Default cursor restored */
        }

        /* --- UI STYLES --- */
        .orbitron { font-family: 'Orbitron', sans-serif; } 
        .mono { font-family: 'Space Mono', monospace; }
        .card-inner { transform-style: preserve-3d; }
        .perspective-container { perspective: 1200px; }

        ::-webkit-scrollbar { width: 8px; } 
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .modal-bg { background: rgba(0, 0, 0, 0.9); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden">

    <nav class="fixed top-0 w-full p-4 flex justify-between items-center z-50 bg-[var(--bg-panel)]/90 backdrop-blur border-b border-[var(--border)]">
        <div class="flex items-center gap-4">
            <button id="termBtn" onclick="showPage('terminal')" class="flex items-center gap-2 text-[var(--primary)] font-bold border border-[var(--primary)] bg-black/40 px-5 py-2 rounded-full shadow-[0_0_15px_rgba(0,243,255,0.2)] transition-all">
                <span class="tracking-[0.15em] text-xs font-mono">TERMINAL</span>
            </button>
            <button id="libBtn" onclick="showPage('library')" class="flex items-center gap-3 text-gray-500 font-bold border border-transparent bg-transparent px-5 py-2 rounded-full hover:text-white transition-all">
                <span class="tracking-[0.15em] text-xs font-mono">VIDEO LIBRARY</span>
            </button>
            <button onclick="toggleVault(true)" class="flex items-center gap-2 text-[var(--accent)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--primary)] hover:text-[var(--primary)] group">
                <span class="text-lg group-hover:animate-pulse">ðŸ”’</span> <span class="tracking-[0.15em] text-xs font-mono">VAULT</span>
            </button>
            <a href="/chat" class="flex items-center gap-2 text-[var(--primary)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--primary)] hover:bg-[var(--primary)] hover:text-black transition-all">
                <span class="text-lg">ðŸ’¬</span> <span class="tracking-[0.15em] text-xs font-mono">CHAT</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black tracking-widest hidden xl:block orbitron">CIPHER <span class="text-[var(--primary)]">VAULT</span></h1>
            <button onclick="logout()" class="px-4 py-2 border border-red-900/50 text-red-500 rounded text-xs font-bold hover:bg-red-900/20">LOGOUT</button>
        </div>
    </nav>

    <main id="terminalPage" class="flex-grow flex items-center justify-center p-4 pt-24 perspective-container h-full">
        <div id="mainCard" class="card-inner w-full max-w-5xl bg-[var(--bg-panel)] border border-[var(--border)] shadow-[var(--glow)] rounded-xl relative overflow-hidden flex flex-col max-h-full">
            
            <div class="p-6 border-b border-[var(--border)] flex justify-between items-center bg-black/20 shrink-0">
                <div>
                    <h2 id="modeTitle" class="text-3xl font-bold tracking-widest orbitron text-[var(--primary)]">ENCRYPTION MODE</h2>
                    <p class="text-[10px] mono text-gray-500">SYSTEM STATUS: READY // AUTO-KEY MEMORY: <span id="memoryStatus" class="text-red-500 font-bold">OFFLINE</span></p>
                </div>
                <button id="swapModeBtn" class="flex items-center gap-3 px-6 py-3 bg-[var(--border)] hover:bg-[var(--primary)] hover:text-black transition-all rounded group">
                    <div class="text-right"><div class="text-[10px] font-bold uppercase opacity-50">Current Mode</div><div class="text-sm font-bold" id="swapBtnText">ENCRYPT</div></div>
                    <svg class="w-6 h-6 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 flex-grow overflow-hidden">
                
                <div class="p-6 space-y-6 border-r border-[var(--border)] relative overflow-y-auto">
                    <div>
                        <label for="algoSelect" class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Algorithm Selection</label>
                        <select id="algoSelect" title="Select Algorithm" aria-label="Select Algorithm" class="w-full bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded text-sm font-bold focus:border-[var(--primary)] outline-none transition-colors text-white font-mono">
                            <optgroup label="Classical Ciphers">
                                <option value="atbash">1. Atbash Cipher</option>
                                <option value="caesar">2. Caesar Cipher</option>
                                <option value="playfair">3. Playfair Cipher</option>
                                <option value="vigenere">4. VigenÃ¨re Cipher</option>
                                <option value="rail_fence">5. Rail Fence Cipher</option>
                                <option value="pigpen">6. Pigpen Cipher</option>
                            </optgroup>
                            <optgroup label="Modern Encryption">
                                <option value="aes" selected>7. AES-256 (Standard)</option>
                                <option value="rsa">8. RSA (Asymmetric)</option>
                                <option value="ecc">9. ECC (Elliptic Curve)</option>
                            </optgroup>
                            <optgroup label="Covert Operations">
                                <option value="steganography">10. Steganography (Image)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div id="dynamicInputs" class="space-y-4">
                        <div id="stdInputGroup">
                            <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Input Data</label>
                            <textarea id="mainInput" title="Enter Text to Encrypt" aria-label="Enter Text to Encrypt" class="w-full h-32 bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded mono text-sm focus:border-[var(--primary)] outline-none resize-none" placeholder="Enter text..."></textarea>
                        </div>

                        <div id="stegoInputGroup" class="hidden">
                            <label class="text-[10px] font-bold text-[var(--accent)] uppercase mb-2 block font-mono">Image Source</label>
                            <input type="file" id="stegoFile" title="Upload Source Image" aria-label="Upload Source Image" accept="image/png" class="w-full text-xs text-gray-500 file:bg-[var(--accent)] file:text-black file:border-0 file:px-2 file:py-1 file:rounded file:font-bold mb-2">
                            <div id="stegoTextContainer">
                                <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Secret Payload</label>
                                <textarea id="stegoPayload" title="Enter Secret Message" aria-label="Enter Secret Message" class="w-full h-20 bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded mono text-sm focus:border-[var(--accent)] outline-none" placeholder="Message to hide..."></textarea>
                            </div>
                        </div>

                        <div id="keyGroup">
                            <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Encryption Key</label>
                            <input id="keyInput" type="text" title="Enter Encryption Key" aria-label="Enter Encryption Key" class="w-full bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded mono text-[var(--primary)] focus:border-[var(--primary)] outline-none" placeholder="Key / Shift / Password">
                            
                            <textarea id="rsaKeyInput" title="RSA Key Input" aria-label="RSA Key Input" class="hidden w-full h-24 bg-[var(--bg-body)] border border-[var(--border)] p-2 rounded mono text-[10px] text-[var(--primary)] focus:border-[var(--primary)] outline-none" placeholder="Paste Key Here... (Leave empty to Auto-Generate on Encrypt)"></textarea>
                        </div>

                        <button id="processBtn" class="w-full py-4 bg-[var(--primary)] text-black font-black tracking-widest rounded hover:shadow-[0_0_20px_rgba(0,243,255,0.4)] transition-all orbitron">
                            EXECUTE PROCESS
                        </button>
                    </div>
                </div>

                <div class="p-6 bg-black/20 flex flex-col h-full relative overflow-y-auto">
                    <div class="flex justify-between items-center mb-4"> 
                        <label class="text-[10px] font-bold text-gray-500 uppercase block font-mono">System Output</label> 
                        <button id="copyBtn" class="flex items-center gap-2 px-3 py-1 border border-[var(--primary)] text-[var(--primary)] hover:bg-[var(--primary)] hover:text-black transition-all rounded text-[10px] font-bold font-mono group">
                            <span>COPY RESULT</span>
                        </button>
                    </div>
                    <div class="flex-grow bg-[var(--bg-body)] border border-[var(--border)] rounded p-4 mono text-sm text-[var(--accent)] break-all whitespace-pre-wrap overflow-y-auto relative">
                        <div id="outputDisplay">// WAITING FOR INPUT...</div>
                        <canvas id="stegoCanvas" class="hidden"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main id="libraryPage" class="hidden flex-grow pt-24 px-4 pb-12 overflow-y-auto h-full">
        <div class="w-full max-w-7xl mx-auto">
            <div class="text-center mb-10">
                <h2 class="text-4xl orbitron text-[var(--primary)] mb-2 tracking-widest">CIPHER <span class="text-white">ARSENAL</span></h2>
                <p class="text-gray-500 font-mono text-xs tracking-[0.3em]">VIDEO TUTORIAL DATABASE</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">1. ATBASH</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Atbash Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/zt5Ax2TmZJI" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">2. CAESAR</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Caesar Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/JtbKh_12ctg" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">3. PLAYFAIR</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Playfair Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/1q37X_y9-lc" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">4. VIGENERE</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Vigenere Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/SkJcmCaHqS0" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">5. RAIL FENCE</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Rail Fence Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/wKjRwJTXQH4" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">6. PIGPEN</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Pigpen Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/vZrTJOhALmA" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">7. AES-256</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="AES Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/O4xNJsjtN6E" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">8. RSA</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="RSA Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/4zahvcJ9glg" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">9. ECC</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="ECC Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/NF1pwjL9-DE" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--accent)] bg-black/40 p-4 rounded-xl hover:border-white transition-all"><h3 class="text-lg orbitron text-[var(--accent)] mb-2">10. STEGANOGRAPHY</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Steganography Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/TWEXCYQKyDc" frameborder="0" allowfullscreen></iframe></div></div>
            </div>
        </div>
    </main>

    <div id="vaultModal" class="fixed inset-0 z-[80] flex items-center justify-center hidden opacity-0 transition-opacity duration-300 pointer-events-none modal-bg">
        <div class="relative bg-[var(--bg-panel)] border border-[var(--primary)] w-full max-w-4xl rounded-xl shadow-[0_0_50px_rgba(0,243,255,0.15)] flex flex-col h-[600px] md:h-auto p-6">
            <div class="flex justify-between items-center mb-6 border-b border-[var(--border)] pb-4">
                <h3 class="text-2xl font-black tracking-widest text-[var(--accent)] orbitron">ZERO-KNOWLEDGE <span class="text-[var(--primary)]">VAULT</span></h3>
                <button onclick="toggleVault(false)" class="text-gray-500 hover:text-white font-mono text-xl">âœ•</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-1 bg-white/5 border border-white/10 rounded p-6">
                    <label class="text-xs font-mono text-[var(--primary)] mb-2 block tracking-widest">1. SELECT ASSET</label>
                    <input type="file" id="vaultInput" title="File Upload" aria-label="File Upload" class="w-full text-xs text-gray-500 mb-4 file:bg-[var(--primary)] file:border-0 file:text-black file:font-bold file:px-2 file:py-1 file:rounded">
                    <label class="text-xs font-mono text-[var(--accent)] mb-2 block tracking-widest">2. PASSWORD</label>
                    <input type="password" id="vaultPass" title="Vault Password" aria-label="Vault Password" placeholder="Required" class="w-full bg-black border border-[var(--border)] text-xs text-[var(--accent)] p-2 rounded mb-4 focus:border-[var(--accent)] outline-none">
                    <button onclick="uploadEncryptedFile()" class="w-full py-3 bg-[var(--accent)] text-black font-black tracking-widest rounded hover:shadow-[0_0_15px_rgba(188,19,254,0.4)] font-mono text-xs">ENCRYPT & UPLOAD</button>
                </div>
                <div class="col-span-2 bg-white/5 border border-white/10 rounded p-6 flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-4 border-b border-[var(--border)] pb-2">
                        <label class="text-xs font-mono text-[var(--primary)] tracking-widest">SECURE DATABASE</label>
                        <button onclick="loadFiles()" class="text-[10px] text-gray-500 hover:text-white font-mono">â†» REFRESH</button>
                    </div>
                    <div id="vaultList" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UI LOGIC ---
        function toggleSpyTools() {
            const el = document.getElementById('spyTools');
            el.classList.toggle('open');
            document.getElementById('toolArrow').innerText = el.classList.contains('open') ? 'â–²' : 'â–¼';
        }

        // --- AUTH & INIT ---
        const token = localStorage.getItem('auth-token');
        if (!token) window.location.href = '/login.html';
        
        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        
        const userPayload = parseJwt(token);
        const userData = userPayload.user || userPayload;
        const myId = userData._id || userData.id; 

        if (!myId) {
            localStorage.removeItem('auth-token');
            window.location.href = '/login.html';
        }

        const socket = io({ auth: { token } });
        let currentReceiver = null;
        let activeUsersMap = {}; 
        const myRSA = new JSEncrypt({ default_key_size: 1024 });
        
        // --- CACHE SYSTEM ---
        function saveToLocalCache(cipher, plain) {
            try {
                let cache = JSON.parse(localStorage.getItem('sent_cache') || '{}');
                cache[cipher] = plain;
                localStorage.setItem('sent_cache', JSON.stringify(cache));
            } catch(e) {}
        }
        
        function getFromLocalCache(cipher) {
            try {
                let cache = JSON.parse(localStorage.getItem('sent_cache') || '{}');
                return cache[cipher];
            } catch(e) { return null; }
        }

        async function initIdentity() {
            let storedPriv = localStorage.getItem('rsa_priv');
            let storedPub = localStorage.getItem('rsa_pub');

            if(!storedPriv || !storedPub) {
                document.getElementById('keyGenStatus').innerText = "GENERATING NEW IDENTITY...";
                myRSA.getKey();
                storedPriv = myRSA.getPrivateKey();
                storedPub = myRSA.getPublicKey();
                localStorage.setItem('rsa_priv', storedPriv);
                localStorage.setItem('rsa_pub', storedPub);
            }
            
            myRSA.setPrivateKey(storedPriv);
            
            try {
                await fetch('/api/users/key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: myId, publicKey: storedPub })
                });
                document.getElementById('keyGenStatus').innerText = "IDENTITY SECURED & SYNCED.";
                document.getElementById('keyGenStatus').className = "mono text-[10px] text-[var(--primary)] mt-2";
            } catch(e) { console.error("Key Sync Failed", e); }
        }
        setTimeout(initIdentity, 100);

        function logout() { localStorage.removeItem('auth-token'); window.location.href = '/login.html'; }

        // --- USER SELECTION ---
        async function selectUser(user, el) {
            currentReceiver = user;
            document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active-user'));
            el.classList.add('active-user');
            
            const statusText = el.querySelector('.status-text');
            if(statusText.innerText.includes("MSG")) statusText.innerText = "ONLINE";

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('messagesArea').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            document.getElementById('chatPartnerName').innerText = user.username;
            
            try {
                const res = await fetch('/api/users');
                const freshUsers = await res.json();
                const freshUser = freshUsers.find(u => u._id === user._id);
                if (freshUser) activeUsersMap[user._id] = freshUser;
                
                const statusEl = document.getElementById('encryptionStatus');
                if(freshUser && freshUser.publicKey && freshUser.publicKey.includes("BEGIN PUBLIC KEY")) {
                    statusEl.innerText = "ðŸ”’ SECURE UPLINK ESTABLISHED";
                    statusEl.className = "text-[9px] mono text-[var(--primary)]";
                } else {
                    statusEl.innerText = "âš ï¸ UNSECURED (PARTNER NEEDS TO RE-LOGIN)";
                    statusEl.className = "text-[9px] mono text-red-500 animate-pulse";
                }
            } catch(e) {}

            document.getElementById('messagesArea').innerHTML = ''; 
            loadHistory(user._id);
        }

        async function fetchUsers() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                const list = document.getElementById('usersList');
                list.innerHTML = '';
                
                users.forEach(u => {
                    if (u._id === myId) return; 
                    activeUsersMap[u._id] = u;

                    const div = document.createElement('div');
                    div.className = 'user-card p-3 cursor-pointer hover:bg-white/5 flex items-center gap-3 border-l-2 border-transparent transition-all';
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-[var(--primary)] font-bold text-xs orbitron">${u.username.substring(0,2).toUpperCase()}</div>
                        <div>
                            <div class="text-sm font-bold text-gray-300">${u.username}</div>
                            <div class="text-[9px] text-gray-600 mono status-text" data-id="${u._id}">OFFLINE</div>
                        </div>
                    `;
                    div.onclick = () => selectUser(u, div);
                    list.appendChild(div);
                });
            } catch(e) { console.error("User Fetch Error", e); }
        }
        fetchUsers();

        // --- SENDING LOGIC (FIXED) ---
        function sendMessage(text, forcedMethod = null, isBurn = false) {
            if(!currentReceiver) return alert("Select a user first!");
            const method = forcedMethod || document.getElementById('cipherMethod').value;
            let cipherText = text;

            if (method === 'rsa') {
                const partnerData = activeUsersMap[currentReceiver._id];
                if (!partnerData || !partnerData.publicKey) {
                    return alert("User key missing. Ask them to login.");
                }
                const encryptor = new JSEncrypt();
                encryptor.setPublicKey(partnerData.publicKey);
                cipherText = encryptor.encrypt(text);
                if(!cipherText) return alert("Message too long for RSA.");
                
                saveToLocalCache(cipherText, text);
            } 
            else if (method === 'caesar') {
                const shift = parseInt(document.getElementById('cipherKey').value) || 3;
                cipherText = text.replace(/[a-zA-Z]/g, c => {
                    const b = c >= 'a' ? 97 : 65;
                    return String.fromCharCode(((c.charCodeAt(0) - b + shift) % 26) + b);
                });
            }

            const payload = {
                senderId: myId,
                receiverId: currentReceiver._id,
                text: cipherText,
                cipherType: method,
                isBurn: isBurn,
                timestamp: new Date()
            };

            socket.emit("private_message", payload);
            
            // --- FIX: DO NOT DISPLAY MANUALLY HERE ---
            // We wait for the server to echo it back with the Real ID.
            // This ensures "A" has the correct ID to delete later.
        }

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            const burn = document.getElementById('burnCheck').checked;
            if(!input.value) return;
            sendMessage(input.value, null, burn);
            input.value = '';
            document.getElementById('burnCheck').checked = false;
        });

        // --- RECEIVING ---
        socket.on("receive_message", (data) => {
            const senderString = String(data.senderId || data.sender);
            const activeReceiverString = currentReceiver ? String(currentReceiver._id) : null;

            // Show if it's from partner OR if it's from ME (Echo confirmation)
            if (activeReceiverString && (senderString === activeReceiverString || senderString === String(myId))) {
                displayMessage(data);
            } else if (senderString !== String(myId)) {
                // Only notify if it's not me
                const userStatus = document.querySelector(`.status-text[data-id="${senderString}"]`);
                if(userStatus) {
                    userStatus.innerText = "ðŸ“© NEW MSG";
                    userStatus.classList.add('text-[var(--primary)]', 'animate-pulse');
                }
            }
        });

        // --- BURN EVENT HANDLER ---
        socket.on("message_burnt", (msgId) => {
            console.log("ðŸ”¥ BURN COMMAND RECEIVED for ID:", msgId);
            const el = document.getElementById(`msg-${msgId}`);
            if(el) {
                el.classList.add('burn-anim');
                setTimeout(() => el.remove(), 1500);
            } else {
                console.warn("Could not find message to burn:", msgId);
            }
        });

        function displayMessage(msg) {
            const area = document.getElementById('messagesArea');
            const senderString = String(msg.sender || msg.senderId);
            const isMe = (senderString === String(myId));
            
            let content = msg.text || msg.cipherText;
            const method = msg.cipherType || 'plain';
            const isBurn = msg.isBurn;
            const msgId = msg._id; // IMPORTANT: This is now always the DB ID

            // If I am sender, try to recover plain text from cache
            if (isMe && method === 'rsa') {
                const cached = getFromLocalCache(content);
                if(cached) { content = cached; msg.originalText = cached; } 
                else if (msg.originalText) { content = msg.originalText; }
            } else if (isMe && msg.originalText) {
                content = msg.originalText;
            }

            const div = document.createElement('div');
            div.id = `msg-${msgId}`; // Assign Real ID
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} msg-enter`;
            
            if (isBurn) div.dataset.burn = "true";

            const color = isBurn ? 'border-red-500/50 text-red-200' : 'border-gray-800 text-gray-300';
            const bg = isMe ? 'bg-white/5' : 'bg-black/40';

            let isLocked = (!isMe && method === 'rsa');
            // If I am sender, RSA is locked if I don't have the cached plain text
            if(isMe && method === 'rsa' && !getFromLocalCache(msg.text) && !msg.originalText) isLocked = true;

            let contentHtml = `<div class="text-xs font-mono break-all">${content}</div>`;
            
            if (isLocked) {
                contentHtml = `
                    <div class="encrypted-text mb-2 break-all" id="cipher-${msgId}">${content.substring(0, 20)}...[ENCRYPTED]</div>
                    <button onclick="unlockMessage('${msgId}', '${content}')" class="w-full bg-white/5 hover:bg-[var(--primary)] hover:text-black border border-white/20 text-[var(--primary)] text-[10px] py-1 rounded transition-all font-bold tracking-widest flex items-center justify-center gap-2">
                        <span>ðŸ”“ UNLOCK DATA</span>
                    </button>
                    <div id="plain-${msgId}" class="hidden text-xs font-mono text-green-400 break-all mt-2 border-t border-white/10 pt-2"></div>
                `;
            }

            const clickAction = (method === 'caesar' && !isMe) ? `onclick="const k=prompt('Shift Key?'); if(k) this.innerText=decryptCaesar(this.innerText, k)"` : '';

            div.innerHTML = `
                <div class="max-w-[75%] rounded-lg p-3 border ${color} ${bg} shadow-lg relative" ${clickAction}>
                    <div class="text-[9px] mb-1 opacity-50 flex justify-between gap-4">
                        <span>${isMe ? 'YOU' : currentReceiver.username}</span>
                        <span>${isBurn ? 'ðŸ”¥ 10s' : new Date().toLocaleTimeString()}</span>
                    </div>
                    ${contentHtml}
                    ${method !== 'plain' ? `<div class="mt-1 pt-1 border-t border-white/5 text-[9px] text-[var(--accent)] font-bold uppercase">ðŸ”’ ${method}</div>` : ''}
                </div>
            `;
            
            area.appendChild(div);
            setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);

            // >>> LOGIC: TRIGGER BURN <<<
            // 1. If UNLOCKED (e.g. Plain/Caesar) AND Burn msg AND I am receiver -> BURN
            if (isBurn && !isMe && !isLocked) {
                socket.emit("message_seen", msgId);
            }
        }
        
        function unlockMessage(id, cipherText) {
            try {
                const myPriv = localStorage.getItem('rsa_priv');
                const decryptor = new JSEncrypt();
                decryptor.setPrivateKey(myPriv);
                const decrypted = decryptor.decrypt(cipherText);
                
                if (decrypted) {
                    document.getElementById(`plain-${id}`).innerText = decrypted;
                    document.getElementById(`plain-${id}`).classList.remove('hidden');
                    document.getElementById(`cipher-${id}`).classList.add('hidden');
                    
                    const container = document.getElementById(`msg-${id}`); 
                    const btn = container ? container.getElementsByTagName('button')[0] : null;
                    if(btn) btn.classList.add('hidden');

                    // >>> RSA TRIGGER BURN ON UNLOCK <<<
                    if (container && container.dataset.burn === "true") {
                        console.log("ðŸ”¥ RSA Unlocked. Starting Burn Sequence for:", id);
                        socket.emit("message_seen", id);
                    }

                } else {
                    alert("Decryption Failed.");
                }
            } catch(e) { console.error(e); alert("Decryption Error"); }
        }

        function decryptCaesar(text, shift) {
             const s = (26 - parseInt(shift)) % 26;
             return text.replace(/[a-zA-Z]/g, c => {
                const b = c >= 'a' ? 97 : 65;
                return String.fromCharCode(((c.charCodeAt(0) - b + s) % 26) + b);
            });
        }

        async function loadHistory(partnerId) {
            try {
                const res = await fetch(`/api/messages/${myId}/${partnerId}`);
                const msgs = await res.json();
                msgs.forEach(displayMessage);
            } catch(e) {}
        }

        socket.on('connect', () => {
            socket.emit("login", myId);
            document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            document.getElementById('statusText').innerText = "ONLINE";
            document.getElementById('statusText').className = "text-green-500";
        });
        
        socket.on('get_users', (onlineIds) => {
            document.querySelectorAll('.status-text').forEach(el => {
                const uid = el.getAttribute('data-id');
                if(onlineIds.includes(uid)) {
                    if (!el.innerText.includes("MSG")) {
                        el.innerText = "ONLINE"; 
                        el.classList.replace('text-gray-600', 'text-[var(--primary)]');
                    }
                } else {
                    el.innerText = "OFFLINE"; el.classList.replace('text-[var(--primary)]', 'text-gray-600');
                }
            });
        });
    </script>
</body>
</html>