<!DOCTYPE html>
<html lang="en" data-theme="void">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cipher Vault | Secure Terminal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Rajdhani:wght@500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;900&display=swap');

        :root[data-theme="void"] { --bg-body: #050508; --bg-panel: #0f1015; --primary: #00f3ff; --accent: #bc13fe; --border: #1e293b; --glow: 0 0 20px rgba(0, 243, 255, 0.2); }
        
        body { 
            background-color: var(--bg-body); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(var(--border) 1px, transparent 1px); 
            background-size: 30px 30px;
            /* Default cursor restored */
        }

        /* --- UI STYLES --- */
        .orbitron { font-family: 'Orbitron', sans-serif; } 
        .mono { font-family: 'Space Mono', monospace; }
        .card-inner { transform-style: preserve-3d; }
        .perspective-container { perspective: 1200px; }

        ::-webkit-scrollbar { width: 8px; } 
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .modal-bg { background: rgba(0, 0, 0, 0.9); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden">

    <nav class="fixed top-0 w-full p-4 flex justify-between items-center z-50 bg-[var(--bg-panel)]/90 backdrop-blur border-b border-[var(--border)]">
        <div class="flex items-center gap-4">
            <button id="termBtn" onclick="showPage('terminal')" class="flex items-center gap-2 text-[var(--primary)] font-bold border border-[var(--primary)] bg-black/40 px-5 py-2 rounded-full shadow-[0_0_15px_rgba(0,243,255,0.2)] transition-all">
                <span class="tracking-[0.15em] text-xs font-mono">TERMINAL</span>
            </button>
            <button id="libBtn" onclick="showPage('library')" class="flex items-center gap-3 text-gray-500 font-bold border border-transparent bg-transparent px-5 py-2 rounded-full hover:text-white transition-all">
                <span class="tracking-[0.15em] text-xs font-mono">VIDEO LIBRARY</span>
            </button>
            <button onclick="toggleVault(true)" class="flex items-center gap-2 text-[var(--accent)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--primary)] hover:text-[var(--primary)] group">
                <span class="text-lg group-hover:animate-pulse">ðŸ”’</span> <span class="tracking-[0.15em] text-xs font-mono">VAULT</span>
            </button>
            <a href="/chat" class="flex items-center gap-2 text-[var(--primary)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full hover:border-[var(--primary)] hover:bg-[var(--primary)] hover:text-black transition-all">
                <span class="text-lg">ðŸ’¬</span> <span class="tracking-[0.15em] text-xs font-mono">CHAT</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-black tracking-widest hidden xl:block orbitron">CIPHER <span class="text-[var(--primary)]">VAULT</span></h1>
            <button onclick="logout()" class="px-4 py-2 border border-red-900/50 text-red-500 rounded text-xs font-bold hover:bg-red-900/20">LOGOUT</button>
        </div>
    </nav>

    <main id="terminalPage" class="flex-grow flex items-center justify-center p-4 pt-24 perspective-container h-full">
        <div id="mainCard" class="card-inner w-full max-w-5xl bg-[var(--bg-panel)] border border-[var(--border)] shadow-[var(--glow)] rounded-xl relative overflow-hidden flex flex-col max-h-full">
            
            <div class="p-6 border-b border-[var(--border)] flex justify-between items-center bg-black/20 shrink-0">
                <div>
                    <h2 id="modeTitle" class="text-3xl font-bold tracking-widest orbitron text-[var(--primary)]">ENCRYPTION MODE</h2>
                    <p class="text-[10px] mono text-gray-500">SYSTEM STATUS: READY // AUTO-KEY MEMORY: <span id="memoryStatus" class="text-red-500 font-bold">OFFLINE</span></p>
                </div>
                <button id="swapModeBtn" class="flex items-center gap-3 px-6 py-3 bg-[var(--border)] hover:bg-[var(--primary)] hover:text-black transition-all rounded group">
                    <div class="text-right"><div class="text-[10px] font-bold uppercase opacity-50">Current Mode</div><div class="text-sm font-bold" id="swapBtnText">ENCRYPT</div></div>
                    <svg class="w-6 h-6 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 flex-grow overflow-hidden">
                
                <div class="p-6 space-y-6 border-r border-[var(--border)] relative overflow-y-auto">
                    <div>
                        <label for="algoSelect" class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Algorithm Selection</label>
                        <select id="algoSelect" title="Select Algorithm" aria-label="Select Algorithm" class="w-full bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded text-sm font-bold focus:border-[var(--primary)] outline-none transition-colors text-white font-mono">
                            <optgroup label="Classical Ciphers">
                                <option value="atbash">1. Atbash Cipher</option>
                                <option value="caesar">2. Caesar Cipher</option>
                                <option value="playfair">3. Playfair Cipher</option>
                                <option value="vigenere">4. VigenÃ¨re Cipher</option>
                                <option value="rail_fence">5. Rail Fence Cipher</option>
                                <option value="pigpen">6. Pigpen Cipher</option>
                            </optgroup>
                            <optgroup label="Modern Encryption">
                                <option value="aes" selected>7. AES-256 (Standard)</option>
                                <option value="rsa">8. RSA (Asymmetric)</option>
                                <option value="ecc">9. ECC (Elliptic Curve)</option>
                            </optgroup>
                            <optgroup label="Covert Operations">
                                <option value="steganography">10. Steganography (Image)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div id="dynamicInputs" class="space-y-4">
                        <div id="stdInputGroup">
                            <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Input Data</label>
                            <textarea id="mainInput" title="Enter Text to Encrypt" aria-label="Enter Text to Encrypt" class="w-full h-32 bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded mono text-sm focus:border-[var(--primary)] outline-none resize-none" placeholder="Enter text..."></textarea>
                        </div>

                        <div id="stegoInputGroup" class="hidden">
                            <label class="text-[10px] font-bold text-[var(--accent)] uppercase mb-2 block font-mono">Image Source</label>
                            <input type="file" id="stegoFile" title="Upload Source Image" aria-label="Upload Source Image" accept="image/png" class="w-full text-xs text-gray-500 file:bg-[var(--accent)] file:text-black file:border-0 file:px-2 file:py-1 file:rounded file:font-bold mb-2">
                            <div id="stegoTextContainer">
                                <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Secret Payload</label>
                                <textarea id="stegoPayload" title="Enter Secret Message" aria-label="Enter Secret Message" class="w-full h-20 bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded mono text-sm focus:border-[var(--accent)] outline-none" placeholder="Message to hide..."></textarea>
                            </div>
                        </div>

                        <div id="keyGroup">
                            <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block font-mono">Encryption Key</label>
                            <input id="keyInput" type="text" title="Enter Encryption Key" aria-label="Enter Encryption Key" class="w-full bg-[var(--bg-body)] border border-[var(--border)] p-3 rounded mono text-[var(--primary)] focus:border-[var(--primary)] outline-none" placeholder="Key / Shift / Password">
                            
                            <textarea id="rsaKeyInput" title="RSA Key Input" aria-label="RSA Key Input" class="hidden w-full h-24 bg-[var(--bg-body)] border border-[var(--border)] p-2 rounded mono text-[10px] text-[var(--primary)] focus:border-[var(--primary)] outline-none" placeholder="Paste Key Here... (Leave empty to Auto-Generate on Encrypt)"></textarea>
                        </div>

                        <button id="processBtn" class="w-full py-4 bg-[var(--primary)] text-black font-black tracking-widest rounded hover:shadow-[0_0_20px_rgba(0,243,255,0.4)] transition-all orbitron">
                            EXECUTE PROCESS
                        </button>
                    </div>
                </div>

                <div class="p-6 bg-black/20 flex flex-col h-full relative overflow-y-auto">
                    <div class="flex justify-between items-center mb-4"> 
                        <label class="text-[10px] font-bold text-gray-500 uppercase block font-mono">System Output</label> 
                        <button id="copyBtn" class="flex items-center gap-2 px-3 py-1 border border-[var(--primary)] text-[var(--primary)] hover:bg-[var(--primary)] hover:text-black transition-all rounded text-[10px] font-bold font-mono group">
                            <span>COPY RESULT</span>
                        </button>
                    </div>
                    <div class="flex-grow bg-[var(--bg-body)] border border-[var(--border)] rounded p-4 mono text-sm text-[var(--accent)] break-all whitespace-pre-wrap overflow-y-auto relative">
                        <div id="outputDisplay">// WAITING FOR INPUT...</div>
                        <canvas id="stegoCanvas" class="hidden"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main id="libraryPage" class="hidden flex-grow pt-24 px-4 pb-12 overflow-y-auto h-full">
        <div class="w-full max-w-7xl mx-auto">
            <div class="text-center mb-10">
                <h2 class="text-4xl orbitron text-[var(--primary)] mb-2 tracking-widest">CIPHER <span class="text-white">ARSENAL</span></h2>
                <p class="text-gray-500 font-mono text-xs tracking-[0.3em]">VIDEO TUTORIAL DATABASE</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">1. ATBASH</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Atbash Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/zt5Ax2TmZJI" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">2. CAESAR</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Caesar Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/JtbKh_12ctg" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">3. PLAYFAIR</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Playfair Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/1q37X_y9-lc" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">4. VIGENERE</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Vigenere Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/SkJcmCaHqS0" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">5. RAIL FENCE</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Rail Fence Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/wKjRwJTXQH4" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">6. PIGPEN</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Pigpen Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/vZrTJOhALmA" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">7. AES-256</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="AES Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/O4xNJsjtN6E" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">8. RSA</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="RSA Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/4zahvcJ9glg" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--border)] bg-black/40 p-4 rounded-xl hover:border-[var(--primary)]"><h3 class="text-lg orbitron text-white mb-2">9. ECC</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="ECC Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/NF1pwjL9-DE" frameborder="0" allowfullscreen></iframe></div></div>
                <div class="border border-[var(--accent)] bg-black/40 p-4 rounded-xl hover:border-white transition-all"><h3 class="text-lg orbitron text-[var(--accent)] mb-2">10. STEGANOGRAPHY</h3><div class="aspect-video w-full border border-gray-700 bg-black"><iframe title="Steganography Tutorial" class="w-full h-full" src="https://www.youtube.com/embed/TWEXCYQKyDc" frameborder="0" allowfullscreen></iframe></div></div>
            </div>
        </div>
    </main>

    <div id="vaultModal" class="fixed inset-0 z-[80] flex items-center justify-center hidden opacity-0 transition-opacity duration-300 pointer-events-none modal-bg">
        <div class="relative bg-[var(--bg-panel)] border border-[var(--primary)] w-full max-w-4xl rounded-xl shadow-[0_0_50px_rgba(0,243,255,0.15)] flex flex-col h-[600px] md:h-auto p-6">
            <div class="flex justify-between items-center mb-6 border-b border-[var(--border)] pb-4">
                <h3 class="text-2xl font-black tracking-widest text-[var(--accent)] orbitron">ZERO-KNOWLEDGE <span class="text-[var(--primary)]">VAULT</span></h3>
                <button onclick="toggleVault(false)" class="text-gray-500 hover:text-white font-mono text-xl">âœ•</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-1 bg-white/5 border border-white/10 rounded p-6">
                    <label class="text-xs font-mono text-[var(--primary)] mb-2 block tracking-widest">1. SELECT ASSET</label>
                    <input type="file" id="vaultInput" title="File Upload" aria-label="File Upload" 
                           onchange="this.classList.add('border-[var(--primary)]', 'shadow-[0_0_10px_rgba(0,243,255,0.3)]')"
                           class="w-full text-xs text-gray-500 mb-4 border border-[var(--border)] rounded p-2 transition-all duration-200
                                  file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 
                                  file:text-xs file:font-black file:bg-[var(--primary)] file:text-black 
                                  file:cursor-pointer file:transition-transform file:active:scale-90 hover:file:bg-white">
                    <label class="text-xs font-mono text-[var(--accent)] mb-2 block tracking-widest">2. PASSWORD</label>
                    <input type="password" id="vaultPass" title="Vault Password" aria-label="Vault Password" placeholder="Required" class="w-full bg-black border border-[var(--border)] text-xs text-[var(--accent)] p-2 rounded mb-4 focus:border-[var(--accent)] outline-none">
                    <button onclick="uploadEncryptedFile()" class="w-full py-3 bg-[var(--accent)] text-black font-black tracking-widest rounded hover:shadow-[0_0_15px_rgba(188,19,254,0.4)] font-mono text-xs">ENCRYPT & UPLOAD</button>
                </div>
                <div class="col-span-2 bg-white/5 border border-white/10 rounded p-6 flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-4 border-b border-[var(--border)] pb-2">
                        <label class="text-xs font-mono text-[var(--primary)] tracking-widest">SECURE DATABASE</label>
                        <button onclick="loadFiles()" class="text-[10px] text-gray-500 hover:text-white font-mono">â†» REFRESH</button>
                    </div>
                    <div id="vaultList" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- AUTH CHECK ---
        const token = localStorage.getItem('auth-token');
        if (!token) window.location.href = '/login.html';
        function logout() { localStorage.removeItem('auth-token'); window.location.href = '/login.html'; }

        // --- GLOBAL STATE ---
        let mode = 'encrypt';
        const keyCache = { rsa: null, aes: null };

        // --- DOM REFERENCES (Fixed) ---
        const DOM = {
            card: document.getElementById('mainCard'),
            algo: document.getElementById('algoSelect'),
            mainIn: document.getElementById('mainInput'),
            keyIn: document.getElementById('keyInput'),
            rsaKeyIn: document.getElementById('rsaKeyInput'),
            out: document.getElementById('outputDisplay'),
            swapBtn: document.getElementById('swapModeBtn'),
            modeTitle: document.getElementById('modeTitle'),
            btnText: document.getElementById('swapBtnText'),
            processBtn: document.getElementById('processBtn'),
            stdGroup: document.getElementById('stdInputGroup'),
            stegoGroup: document.getElementById('stegoInputGroup'),
            keyGroup: document.getElementById('keyGroup'),
            stegoFile: document.getElementById('stegoFile'),
            stegoPayload: document.getElementById('stegoPayload'),
            stegoTextCont: document.getElementById('stegoTextContainer'),
            memStatus: document.getElementById('memoryStatus')
            // Note: Canvas accessed dynamically now to prevent null errors
        };

        // --- NAVIGATION LOGIC (Fixed Flex/Hidden Conflict) ---
        function showPage(page) {
            const term = document.getElementById('terminalPage');
            const lib = document.getElementById('libraryPage');
            const termBtn = document.getElementById('termBtn');
            const libBtn = document.getElementById('libBtn');

            if(page === 'terminal') {
                // Show Terminal
                term.classList.remove('hidden');
                term.classList.add('flex'); // Restore flex layout
                
                // Hide Library
                lib.classList.add('hidden');
                
                // Update Buttons
                termBtn.className = "flex items-center gap-2 text-[var(--primary)] font-bold border border-[var(--primary)] bg-black/40 px-5 py-2 rounded-full shadow-[0_0_15px_rgba(0,243,255,0.2)] transition-all";
                libBtn.className = "flex items-center gap-3 text-gray-500 font-bold border border-transparent bg-transparent px-5 py-2 rounded-full hover:text-white transition-all";
            } else {
                // Hide Terminal
                term.classList.add('hidden');
                term.classList.remove('flex'); // Remove flex so hidden works
                
                // Show Library
                lib.classList.remove('hidden');
                
                // Update Buttons
                libBtn.className = "flex items-center gap-3 text-[var(--primary)] font-bold border border-[var(--border)] bg-black/20 px-5 py-2 rounded-full transition-all";
                termBtn.className = "flex items-center gap-2 text-gray-500 font-bold border border-transparent bg-transparent px-5 py-2 rounded-full hover:text-white transition-all";
            }
        }

        // --- ANIMATION ENGINE ---
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+";
        function animateText(element, finalState) {
            let iterations = 0;
            const interval = setInterval(() => {
                element.innerText = finalState.split("").map((letter, index) => {
                    if(index < iterations) return finalState[index];
                    return letters[Math.floor(Math.random() * 26)];
                }).join("");
                if(iterations >= finalState.length) { clearInterval(interval); element.innerText = finalState; }
                iterations += 1;
            }, 5);
        }

        // --- UPDATE MEMORY UI ---
        function updateMemoryStatus() {
            if (keyCache.rsa || keyCache.aes) {
                DOM.memStatus.innerText = "ACTIVE";
                DOM.memStatus.className = "text-green-500 font-bold animate-pulse";
            } else {
                DOM.memStatus.innerText = "OFFLINE";
                DOM.memStatus.className = "text-red-500 font-bold";
            }
        }

        // --- FLIP CARD LOGIC ---
        DOM.swapBtn.onclick = () => {
            gsap.to(DOM.card, { rotationY: 90, duration: 0.2, onComplete: () => {
                mode = mode === 'encrypt' ? 'decrypt' : 'encrypt';
                DOM.modeTitle.innerText = mode === 'encrypt' ? "ENCRYPTION MODE" : "DECRYPTION MODE";
                DOM.modeTitle.style.color = mode === 'encrypt' ? "var(--primary)" : "#ff2a2a";
                DOM.btnText.innerText = mode === 'encrypt' ? "ENCRYPT" : "DECRYPT";
                DOM.processBtn.innerText = mode === 'encrypt' ? "EXECUTE ENCRYPTION" : "EXECUTE DECRYPTION";
                DOM.processBtn.style.backgroundColor = mode === 'encrypt' ? "var(--primary)" : "#ff2a2a";
                DOM.out.innerText = "// WAITING FOR INPUT...";
                
                // Logic updates for specific modes
                if (DOM.algo.value === 'steganography') {
                    if (mode === 'encrypt') {
                        DOM.stegoTextCont.classList.remove('hidden'); 
                        DOM.processBtn.innerText = "ENCODE & DOWNLOAD";
                    } else {
                        DOM.stegoTextCont.classList.add('hidden');
                        DOM.processBtn.innerText = "DECODE IMAGE";
                    }
                }
                
                // Key Placeholder Updates
                if (DOM.algo.value === 'rsa') {
                    DOM.rsaKeyIn.placeholder = (mode === 'decrypt' && keyCache.rsa) 
                        ? "[ACCESSING CACHED PRIVATE KEY...] (Leave empty to use)" 
                        : (mode === 'encrypt' ? "Paste Public Key... (Auto-Generate)" : "Paste Private Key...");
                }
                if (DOM.algo.value === 'aes' && mode === 'decrypt' && keyCache.aes) {
                    DOM.keyIn.placeholder = "[ACCESSING CACHED KEY...] (Leave empty to use)";
                }

                gsap.to(DOM.card, { rotationY: 0, duration: 0.3 });
            }});
        };

        // --- ALGO SELECTION LOGIC ---
        DOM.algo.addEventListener('change', () => {
            const val = DOM.algo.value;
            const isStego = val === 'steganography';
            const isRSA = val === 'rsa';
            const isAsym = ['rsa', 'ecc'].includes(val);
            
            DOM.stdGroup.classList.toggle('hidden', isStego);
            DOM.stegoGroup.classList.toggle('hidden', !isStego);
            DOM.keyGroup.classList.toggle('hidden', isStego || (isAsym && !isRSA));
            
            if (isRSA) {
                DOM.keyIn.classList.add('hidden');
                DOM.rsaKeyIn.classList.remove('hidden');
            } else {
                DOM.keyIn.classList.remove('hidden');
                DOM.rsaKeyIn.classList.add('hidden');
            }

            DOM.out.innerText = "// WAITING...";
            if(val === 'ecc') DOM.processBtn.innerText = "GENERATE CURVE KEYS (SIMULATION)";
            else DOM.processBtn.innerText = mode === 'encrypt' ? "EXECUTE ENCRYPTION" : "EXECUTE DECRYPTION";
            
            DOM.modeTitle.innerText = isStego ? "STEGANOGRAPHY LAB" : (mode === 'encrypt' ? "ENCRYPTION MODE" : "DECRYPTION MODE");
            DOM.modeTitle.style.color = isStego ? "var(--accent)" : (mode === 'encrypt' ? "var(--primary)" : "#ff2a2a");
        });

        // --- PROCESS BUTTON (ENCRYPTION ENGINE) ---
        DOM.processBtn.onclick = () => {
            const algo = DOM.algo.value;
            
            // 1. STEGANOGRAPHY
            if (algo === 'steganography') {
                const cvs = document.getElementById('stegoCanvas'); // Hidden canvas in HTML
                const ctx = cvs.getContext('2d');
                
                if (mode === 'encrypt') {
                    if(!DOM.stegoFile.files[0] || !DOM.stegoPayload.value) return alert("Image and Text required!");
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            cvs.width = img.width; cvs.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            const imgData = ctx.getImageData(0,0,img.width,img.height);
                            const msg = DOM.stegoPayload.value;
                            
                            // Basic LSB Encoding
                            let bin = ""; 
                            for(let i=0; i<msg.length; i++) bin += msg.charCodeAt(i).toString(2).padStart(8,'0');
                            bin += "00000000"; // Terminator
                            
                            if(bin.length > imgData.data.length/4) return alert("Message too long for image");
                            
                            let dIdx = 0;
                            for(let i=0; i<bin.length; i++) {
                                if(dIdx%4===3) dIdx++; // Skip Alpha channel
                                imgData.data[dIdx] = (imgData.data[dIdx] & 254) | parseInt(bin[i]);
                                dIdx++;
                            }
                            ctx.putImageData(imgData, 0, 0);
                            
                            const link = document.createElement('a');
                            link.download = 'secret_stego.png';
                            link.href = cvs.toDataURL();
                            link.click();
                            animateText(DOM.out, "SUCCESS: Encoded Image Downloaded.");
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(DOM.stegoFile.files[0]);
                } else {
                    // DECRYPT STEGO
                    if(!DOM.stegoFile.files[0]) return alert("Select Image to Decode");
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            cvs.width = img.width; cvs.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            const data = ctx.getImageData(0,0,img.width,img.height).data;
                            let bin = "", res = "";
                            for(let i=0; i<data.length; i++) {
                                if(i%4===3) continue;
                                bin += (data[i]&1).toString();
                                if(bin.length===8) {
                                    if(bin==="00000000") break;
                                    res += String.fromCharCode(parseInt(bin, 2));
                                    bin = "";
                                }
                            }
                            animateText(DOM.out, "DECODED SECRET:\n" + res);
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(DOM.stegoFile.files[0]);
                }
                return;
            }

            // 2. TEXT CIPHERS
            const txt = DOM.mainIn.value;
            let key = DOM.keyIn.value;
            let res = "";

            if (algo === 'rsa') {
                const encryptor = new JSEncrypt({default_key_size: 512});
                const rsaKeyVal = DOM.rsaKeyIn.value.trim();

                if (mode === 'encrypt') {
                    let pubKey = rsaKeyVal;
                    let extra = "";
                    if (!pubKey) {
                        pubKey = encryptor.getPublicKey();
                        keyCache.rsa = encryptor.getPrivateKey();
                        updateMemoryStatus();
                        extra = "\n\n[PRIVATE KEY CACHED FOR SESSION]";
                        encryptor.setPublicKey(pubKey);
                    } else { encryptor.setPublicKey(pubKey); }
                    
                    const enc = encryptor.encrypt(txt);
                    res = enc ? "CIPHERTEXT:\n" + enc + extra : "ENCRYPTION FAILED";
                } else {
                    let privKey = rsaKeyVal || keyCache.rsa;
                    if(!privKey) return alert("Private Key Required");
                    encryptor.setPrivateKey(privKey);
                    const dec = encryptor.decrypt(txt);
                    res = dec ? "DECRYPTED:\n" + dec : "DECRYPTION FAILED";
                }
            } 
            else if (algo === 'aes') {
                if (mode === 'encrypt') {
                    if(!key) return alert("Key Required");
                    keyCache.aes = key; updateMemoryStatus();
                    res = CryptoJS.AES.encrypt(txt, key).toString();
                } else {
                    let useKey = key || keyCache.aes;
                    if(!useKey) return alert("Key Required");
                    try {
                        const bytes = CryptoJS.AES.decrypt(txt, useKey);
                        res = bytes.toString(CryptoJS.enc.Utf8) || "DECRYPTION FAILED (Wrong Key)";
                    } catch(e) { res = "INVALID CIPHERTEXT"; }
                }
            }
            else {
                // SIMPLE CIPHERS
                if(algo === 'caesar') {
                    const shift = parseInt(key) || 3;
                    const s = mode==='encrypt' ? shift : -shift;
                    res = txt.replace(/[a-zA-Z]/g, c => {
                        const b = c>='a'?97:65;
                        return String.fromCharCode(((c.charCodeAt(0)-b+s)%26+26)%26+b);
                    });
                } else {
                    res = `[SIMULATION] ${algo.toUpperCase()} RESULT FOR:\n${txt}`;
                }
            }
            animateText(DOM.out, res);
        };

        // --- VAULT LOGIC ---
        const vaultModal = document.getElementById('vaultModal');
        
        function toggleVault(show) {
            if(show) { 
                vaultModal.classList.remove('hidden','pointer-events-none'); 
                setTimeout(()=>vaultModal.classList.remove('opacity-0'), 10);
                loadFiles(); 
            } else { 
                vaultModal.classList.add('opacity-0','pointer-events-none'); 
                setTimeout(()=>vaultModal.classList.add('hidden'), 300); 
            }
        }

        async function uploadEncryptedFile() {
            const fi = document.getElementById('vaultInput'); 
            const pw = document.getElementById('vaultPass').value;
            if(!fi.files[0] || !pw) return alert("File and Password required!");
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const enc = CryptoJS.AES.encrypt(e.target.result, pw).toString();
                const blob = new Blob([enc],{type:'text/plain'});
                const f = new File([blob], fi.files[0].name+".enc", {type:"text/plain"});
                
                const fd = new FormData(); 
                fd.append('vaultFile', f);
                
                try {
                    await fetch('/api/vault/upload', {
                        method:'POST', 
                        headers:{'auth-token':token}, 
                        body:fd
                    });
                    loadFiles();
                    alert("File Encrypted & Uploaded to Vault.");
                } catch(err) { alert("Upload Failed"); }
            }; 
            reader.readAsDataURL(fi.files[0]);
        }

        async function loadFiles() {
            try { 
                const res = await fetch('/api/vault/myfiles', {headers:{'auth-token':token}}); 
                const files = await res.json();
                const list = document.getElementById('vaultList'); 
                list.innerHTML = '';
                
                if(files.length === 0) list.innerHTML = '<div class="text-xs text-gray-500 p-2 font-mono">VAULT EMPTY</div>';

                files.forEach(f => { 
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-black/40 border border-white/5 mb-2 rounded hover:border-[var(--primary)] transition-colors group">
                        <span class="text-xs text-gray-400 truncate w-40 font-mono group-hover:text-white transition-colors">${f.originalName}</span>
                        <div class="flex gap-2">
                            <button onclick="downloadAndDecrypt('${f.filename}','${f.originalName}')" class="text-[var(--primary)] text-[9px] border border-[var(--primary)] px-3 py-1 rounded hover:bg-[var(--primary)] hover:text-black font-bold transition-all active:scale-95">DECRYPT</button>
                            <button onclick="deleteFile('${f._id}')" class="text-red-500 text-[9px] border border-red-500 px-3 py-1 rounded hover:bg-red-500 hover:text-black font-bold transition-all active:scale-95">DELETE</button>
                        </div>
                    </div>`; 
                });
            } catch(e){ console.log("Vault Load Error", e); }
        }

        async function downloadAndDecrypt(fname, og) {
            const pw = prompt("ENTER DECRYPTION PASSWORD:"); 
            if(!pw) return;
            
            try {
                const res = await fetch(`/api/vault/file/${fname}?token=${token}`);
                if(!res.ok) throw new Error("Download failed");
                const txt = await res.text();
                
                const dec = CryptoJS.AES.decrypt(txt, pw).toString(CryptoJS.enc.Utf8);
                if(!dec.startsWith('data:')) throw new Error("Decryption failed");
                
                const a = document.createElement('a'); 
                a.href = dec; 
                a.download = og.replace('.enc',''); 
                a.click();
            } catch(e) { alert("ACCESS DENIED: INCORRECT PASSWORD"); }
        }

        async function deleteFile(id) {
            if(!confirm("âš ï¸ PERMANENTLY DELETE THIS FILE?")) return;
            
            try {
                const res = await fetch(`/api/vault/delete/${id}`, {
                    method: 'DELETE',
                    headers: {'auth-token': token}
                });
                
                if(res.ok) {
                    loadFiles(); // Refresh list
                } else {
                    alert("Delete Failed");
                }
            } catch(e) { console.error(e); alert("System Error"); }
        }
        
        document.getElementById('copyBtn').onclick = () => navigator.clipboard.writeText(DOM.out.innerText);
    </script>
</body>
</html>