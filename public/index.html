<!DOCTYPE html>
<html lang="en" data-theme="void">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptPact | Secure Uplink</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;900&display=swap');

        :root[data-theme="void"] { --bg-body: #050508; --bg-panel: #0f1015; --primary: #00f3ff; --accent: #bc13fe; --border: #1e293b; }
        
        body { 
            background-color: var(--bg-body); 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(var(--border) 1px, transparent 1px); 
            background-size: 30px 30px;
            overflow: hidden; 
        }

        .orbitron { font-family: 'Orbitron', sans-serif; } 
        .mono { font-family: 'Space Mono', monospace; }

        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; } 
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .mobile-hide { display: none; }
        @media (min-width: 768px) {
            .mobile-hide { display: flex; }
            .mobile-full { width: auto; }
        }
        
        .msg-enter { animation: slideIn 0.2s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .burn-anim { animation: burnOut 1s forwards; }
        @keyframes burnOut { 0% { filter: blur(0); opacity: 1; } 50% { filter: blur(4px) hue-rotate(90deg); color: red; } 100% { opacity: 0; } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <nav class="h-16 shrink-0 border-b border-[var(--border)] bg-[var(--bg-panel)]/90 backdrop-blur flex justify-between items-center px-4 z-50">
        <div class="flex items-center gap-3">
            <a href="/" class="flex items-center gap-2 text-[var(--primary)] border border-[var(--primary)] bg-black/40 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-[var(--primary)] hover:text-black transition-all">
                <span>‚Üê</span> <span class="hidden sm:inline font-mono">TERMINAL</span>
            </a>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/40 border border-[var(--border)]">
                <div id="statusDot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span id="statusText" class="text-[10px] font-mono text-gray-500">OFFLINE</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="muteBtn" onclick="SoundFX.toggle()" class="text-[10px] mono text-gray-500 border border-[var(--border)] px-3 py-1.5 rounded hover:text-[var(--primary)] transition-all">üîä ON</button>
            <button onclick="logout()" class="text-[10px] font-bold text-red-500 border border-red-900/50 px-3 py-1.5 rounded hover:bg-red-900/20 transition-all">LOGOUT</button>
        </div>
    </nav>

    <div class="flex-grow flex relative overflow-hidden">
        
        <div id="sidebarPanel" class="w-full md:w-80 border-r border-[var(--border)] bg-black/20 flex flex-col z-20 absolute inset-0 md:relative bg-[var(--bg-body)] md:bg-transparent">
            <div class="p-4 border-b border-[var(--border)] bg-[var(--bg-panel)]">
                <h2 class="text-sm font-bold tracking-widest text-gray-400 mb-2 orbitron">ACTIVE AGENTS</h2>
                <div id="keyGenStatus" class="text-[9px] mono text-gray-600">INITIALIZING ENCRYPTION...</div>
            </div>
            <div id="usersList" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
        </div>

        <div id="chatMain" class="w-full md:flex-1 flex flex-col bg-[var(--bg-body)] z-30 absolute inset-0 md:relative translate-x-full md:translate-x-0 transition-transform duration-300">
            
            <div id="chatHeader" class="h-14 border-b border-[var(--border)] flex justify-between items-center px-4 bg-[var(--bg-panel)] shrink-0 hidden">
                <div class="flex items-center gap-3">
                    <button onclick="closeChatMobile()" class="md:hidden text-[var(--primary)] text-xl font-bold p-2">‚Üê</button>
                    <div>
                        <div id="chatPartnerName" class="font-bold text-sm text-white orbitron">SELECT TARGET</div>
                        <div id="encryptionStatus" class="text-[9px] mono text-gray-600">WAITING...</div>
                    </div>
                </div>
                <button onclick="toggleSpyTools()" class="text-[var(--accent)] text-xs border border-[var(--border)] px-3 py-1 rounded hover:bg-[var(--accent)] hover:text-black transition-all flex items-center gap-2">
                    <span>TOOLS</span> <span id="toolArrow">‚ñº</span>
                </button>
            </div>

            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 pointer-events-none hidden md:flex">
                <div class="text-4xl mb-4 opacity-20">üì°</div>
                <p class="font-mono text-xs tracking-widest">SELECT AN AGENT TO BEGIN</p>
                <p class="font-mono text-[10px] text-[var(--primary)] mt-2 opacity-50">IDENTITY SECURED & SYNCED.</p>
            </div>

            <div id="messagesArea" class="flex-grow overflow-y-auto p-4 space-y-3 relative hidden"></div>

            <div id="spyTools" class="h-0 overflow-hidden bg-black/50 border-b border-[var(--border)] transition-all duration-300 absolute top-14 w-full z-40 backdrop-blur-md">
                <div class="p-4 grid grid-cols-2 gap-4">
                    <div>
                        <label for="cipherMethod" class="text-[9px] text-[var(--primary)] block mb-1">ENCRYPTION METHOD</label>
                        <select id="cipherMethod" title="Encryption Method" aria-label="Encryption Method" class="w-full bg-black border border-[var(--border)] text-xs p-1 rounded text-gray-300">
                            <option value="rsa">RSA-2048 (ASYMMETRIC)</option>
                            <option value="aes">AES-256 (SYMMETRIC)</option>
                            <option value="caesar">CAESAR (CLASSIC)</option>
                        </select>
                    </div>
                    <div>
                        <label for="cipherKey" class="text-[9px] text-[var(--accent)] block mb-1">SHIFT KEY (Caesar Only)</label>
                        <input type="number" id="cipherKey" title="Caesar Shift Key" placeholder="3" value="3" class="w-full bg-black border border-[var(--border)] text-xs p-1 rounded text-gray-300">
                    </div>
                </div>
            </div>

            <div id="inputArea" class="p-3 border-t border-[var(--border)] bg-[var(--bg-panel)] shrink-0 hidden">
                <form id="chatForm" class="flex gap-2 items-end">
                    <div class="relative flex-grow">
                        <input type="file" id="stegoImgInput" title="Steganography Image Input" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                        <button type="button" id="attachBtn" onclick="document.getElementById('stegoImgInput').click()" class="absolute left-2 top-2 text-gray-500 hover:text-white transition-colors text-lg" aria-label="Attach Image">üìé</button>
                        <textarea id="msgInput" rows="1" title="Message Input" placeholder="Type a secure message..." class="w-full bg-black/50 border border-[var(--border)] text-sm text-gray-200 rounded-lg py-3 pl-10 pr-10 focus:border-[var(--primary)] outline-none resize-none font-mono"></textarea>
                    </div>
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-1 justify-center" title="Self Destruct">
                            <input type="checkbox" id="burnCheck" title="Self Destruct Toggle" class="accent-red-500 w-3 h-3">
                            <label for="burnCheck" class="text-[9px] text-red-500 font-bold cursor-pointer">BURN</label>
                        </div>
                        <button type="submit" class="bg-[var(--primary)] text-black px-4 py-2 rounded-lg font-bold text-xs hover:shadow-[0_0_15px_var(--primary)] transition-all">SEND</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <canvas id="procCanvas" class="hidden"></canvas>

    <script>
        const SoundFX = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            muted: false,
            toggle: function() {
                this.muted = !this.muted;
                document.getElementById('muteBtn').innerText = this.muted ? "üîá OFF" : "üîä ON";
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playOscillator: function(freq, type, duration, vol=0.1) {
                if(this.muted) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playWhiteNoise: function(duration) {
                if(this.muted) return;
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                noise.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },
            send: function() { this.playOscillator(1200, 'sine', 0.1); },
            receive: function() { this.playOscillator(800, 'square', 0.1); setTimeout(() => this.playOscillator(1200, 'square', 0.2), 100); },
            decrypt: function() { this.playOscillator(200, 'sawtooth', 0.5); setTimeout(() => this.playOscillator(600, 'sine', 0.3), 100); },
            burn: function() { this.playWhiteNoise(0.5); }
        };

        const token = localStorage.getItem('auth-token');
        if (!token) window.location.href = '/login.html';
        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        const userPayload = parseJwt(token);
        const userData = userPayload.user || userPayload;
        const myId = userData._id || userData.id; 
        if (!myId) { localStorage.removeItem('auth-token'); window.location.href = '/login.html'; }

        const socket = io({ auth: { token } });
        let currentReceiver = null;
        let activeUsersMap = {}; 
        const myRSA = new JSEncrypt({ default_key_size: 1024 });
        
        let selectedImage = null;

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedImage = e.target.result;
                    document.getElementById('attachBtn').classList.add('bg-[var(--primary)]', 'text-black', 'border-transparent');
                    document.getElementById('msgInput').placeholder = "Type secret message to hide in image...";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveToLocalCache(cipher, plain) { try { let c = JSON.parse(localStorage.getItem('sent_cache') || '{}'); c[cipher] = plain; localStorage.setItem('sent_cache', JSON.stringify(c)); } catch(e){} }
        function getFromLocalCache(cipher) { try { let c = JSON.parse(localStorage.getItem('sent_cache') || '{}'); return c[cipher]; } catch(e) { return null; } }

        async function initIdentity() {
            let storedPriv = localStorage.getItem('rsa_priv');
            let storedPub = localStorage.getItem('rsa_pub');
            if(!storedPriv || !storedPub) {
                document.getElementById('keyGenStatus').innerText = "GENERATING NEW IDENTITY...";
                myRSA.getKey();
                storedPriv = myRSA.getPrivateKey();
                storedPub = myRSA.getPublicKey();
                localStorage.setItem('rsa_priv', storedPriv);
                localStorage.setItem('rsa_pub', storedPub);
            }
            myRSA.setPrivateKey(storedPriv);
            try {
                await fetch('/api/users/key', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: myId, publicKey: storedPub }) });
                document.getElementById('keyGenStatus').innerText = "IDENTITY SECURED & SYNCED.";
                document.getElementById('keyGenStatus').className = "mono text-[10px] text-[var(--primary)] mt-2";
            } catch(e) {}
        }
        setTimeout(initIdentity, 100);
        function logout() { localStorage.removeItem('auth-token'); window.location.href = '/login.html'; }

        function openChatMobile() {
            document.getElementById('chatMain').classList.remove('translate-x-full');
            document.getElementById('sidebarPanel').classList.add('pointer-events-none'); 
        }

        function closeChatMobile() {
            document.getElementById('chatMain').classList.add('translate-x-full');
            document.getElementById('sidebarPanel').classList.remove('pointer-events-none');
        }

        async function selectUser(user, el) {
            currentReceiver = user;
            document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active-user', 'bg-white/10'));
            el.classList.add('active-user', 'bg-white/10');
            const statusText = el.querySelector('.status-text');
            if(statusText.innerText.includes("MSG")) statusText.innerText = "ONLINE";
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('messagesArea').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            document.getElementById('chatPartnerName').innerText = user.username;
            
            openChatMobile(); 

            try {
                const res = await fetch('/api/users');
                const freshUsers = await res.json();
                const freshUser = freshUsers.find(u => u._id === user._id);
                if (freshUser) activeUsersMap[user._id] = freshUser;
                const statusEl = document.getElementById('encryptionStatus');
                if(freshUser && freshUser.publicKey && freshUser.publicKey.includes("BEGIN PUBLIC KEY")) {
                    statusEl.innerText = "üîí SECURE UPLINK ESTABLISHED"; statusEl.className = "text-[9px] mono text-[var(--primary)]";
                } else {
                    statusEl.innerText = "‚ö†Ô∏è UNSECURED"; statusEl.className = "text-[9px] mono text-red-500 animate-pulse";
                }
            } catch(e) {}
            document.getElementById('messagesArea').innerHTML = ''; 
            loadHistory(user._id);
        }

        async function fetchUsers() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                const list = document.getElementById('usersList');
                list.innerHTML = '';
                users.forEach(u => {
                    if (u._id === myId) return; 
                    activeUsersMap[u._id] = u;
                    const div = document.createElement('div');
                    div.className = 'user-card p-3 cursor-pointer hover:bg-white/5 flex items-center gap-3 border-l-2 border-transparent transition-all rounded bg-black/40 mb-1';
                    div.innerHTML = `<div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-[var(--primary)] font-bold text-xs orbitron border border-[var(--border)]">${u.username.substring(0,2).toUpperCase()}</div><div><div class="text-sm font-bold text-gray-300">${u.username}</div><div class="text-[9px] text-gray-600 mono status-text" data-id="${u._id}">OFFLINE</div></div>`;
                    div.onclick = () => selectUser(u, div);
                    list.appendChild(div);
                });
            } catch(e) {}
        }
        fetchUsers();

        function handleCommand(cmd) {
            const args = cmd.split(' ');
            const main = args[0].toLowerCase();
            const area = document.getElementById('messagesArea');

            const sysMsg = (text, isError=false) => {
                const div = document.createElement('div');
                div.className = "text-[10px] font-mono p-2 my-2 border-l-2 " + (isError ? "border-red-500 text-red-400 bg-red-900/10" : "border-[var(--primary)] text-[var(--primary)] bg-cyan-900/10");
                div.innerHTML = `<strong>SYSTEM:</strong> ${text}`;
                area.appendChild(div);
                area.scrollTop = area.scrollHeight;
            };

            switch(main) {
                case '/clear':
                    area.innerHTML = '';
                    sysMsg("TERMINAL BUFFER CLEARED.");
                    break;
                case '/burn':
                    const msgs = document.querySelectorAll('.msg-enter');
                    if(msgs.length === 0) { sysMsg("NO TARGETS FOUND.", true); return; }
                    SoundFX.burn();
                    sysMsg(`INITIATING MASS DELETE SEQUENCE (${msgs.length} OBJECTS)...`);
                    msgs.forEach((el, i) => {
                        setTimeout(() => {
                            el.classList.add('burn-anim');
                            setTimeout(() => el.remove(), 1000);
                        }, i * 100);
                    });
                    break;
                case '/id':
                    const pubKey = localStorage.getItem('rsa_pub') || "UNKNOWN";
                    const shortKey = pubKey.substring(30, 60) + "...";
                    sysMsg(`SESSION ID: ${myId}<br>FINGERPRINT: ${shortKey}`);
                    break;
                case '/help':
                    sysMsg(`AVAILABLE COMMANDS:<br>‚Ä¢ /clear - Wipe local screen<br>‚Ä¢ /burn - Destroy visible msgs<br>‚Ä¢ /id - Show identity info<br>‚Ä¢ /help - Show this menu`);
                    break;
                default:
                    sysMsg(`UNKNOWN COMMAND: ${main}`, true);
            }
        }

        function sendMessage(text, forcedMethod = null, isBurn = false) {
            if(!currentReceiver) return alert("Select a user first!");
            const method = forcedMethod || document.getElementById('cipherMethod').value;
            
            if (selectedImage) {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.getElementById('procCanvas');
                    const ctx = cvs.getContext('2d');
                    cvs.width = img.width; cvs.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const imgData = ctx.getImageData(0,0,img.width,img.height);
                    
                    let bin = ""; 
                    for(let i=0; i<text.length; i++) bin += text.charCodeAt(i).toString(2).padStart(8,'0');
                    bin += "00000000"; 
                    
                    let dIdx = 0;
                    for(let i=0; i<bin.length; i++) {
                        if(dIdx%4===3) dIdx++;
                        imgData.data[dIdx] = (imgData.data[dIdx] & 254) | parseInt(bin[i]);
                        dIdx++;
                    }
                    ctx.putImageData(imgData, 0, 0);
                    const stegoDataUrl = cvs.toDataURL(); 

                    const payload = {
                        senderId: myId, receiverId: currentReceiver._id,
                        text: stegoDataUrl, 
                        cipherType: 'steganography', 
                        isBurn: isBurn, timestamp: new Date()
                    };
                    socket.emit("private_message", payload);
                    SoundFX.send();
                    
                    selectedImage = null;
                    document.getElementById('attachBtn').classList.remove('bg-[var(--primary)]', 'text-black', 'border-transparent');
                    document.getElementById('msgInput').placeholder = "Type a secure message...";
                    document.getElementById('stegoImgInput').value = "";
                };
                img.src = selectedImage;
                return; 
            }

            let cipherText = text;
            if (method === 'rsa') {
                const partnerData = activeUsersMap[currentReceiver._id];
                if (!partnerData || !partnerData.publicKey) return alert("User key missing.");
                const encryptor = new JSEncrypt();
                encryptor.setPublicKey(partnerData.publicKey);
                cipherText = encryptor.encrypt(text);
                if(!cipherText) return alert("Message too long for RSA.");
                saveToLocalCache(cipherText, text);
            } 
            else if (method === 'caesar') {
                const shift = parseInt(document.getElementById('cipherKey').value) || 3;
                cipherText = text.replace(/[a-zA-Z]/g, c => {
                    const b = c >= 'a' ? 97 : 65;
                    return String.fromCharCode(((c.charCodeAt(0) - b + shift) % 26) + b);
                });
            }

            const payload = {
                senderId: myId, receiverId: currentReceiver._id,
                text: cipherText, cipherType: method, isBurn: isBurn, timestamp: new Date()
            };
            socket.emit("private_message", payload);
            SoundFX.send();
        }

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            const burn = document.getElementById('burnCheck').checked;
            const val = input.value.trim();
            
            if(!val) return;

            if (val.startsWith('/')) {
                handleCommand(val);
                input.value = '';
                return;
            }

            sendMessage(val, null, burn);
            input.value = '';
            document.getElementById('burnCheck').checked = false;
        });

        socket.on("receive_message", (data) => {
            const senderString = String(data.senderId || data.sender);
            const activeReceiverString = currentReceiver ? String(currentReceiver._id) : null;
            if (activeReceiverString && (senderString === activeReceiverString || senderString === String(myId))) {
                displayMessage(data);
                if (senderString !== String(myId)) SoundFX.receive();
            } else if (senderString !== String(myId)) {
                SoundFX.receive();
                const userStatus = document.querySelector(`.status-text[data-id="${senderString}"]`);
                if(userStatus) { userStatus.innerText = "üì© NEW MSG"; userStatus.classList.add('text-[var(--primary)]', 'animate-pulse'); }
            }
        });

        socket.on("message_burnt", (msgId) => {
            const el = document.getElementById(`msg-${msgId}`);
            if(el) { SoundFX.burn(); el.classList.add('burn-anim'); setTimeout(() => el.remove(), 1500); }
        });

        function displayMessage(msg) {
            const area = document.getElementById('messagesArea');
            const senderString = String(msg.sender || msg.senderId);
            const isMe = (senderString === String(myId));
            
            let content = msg.text || msg.cipherText;
            let method = msg.cipherType || 'plain'; 
            const isBurn = msg.isBurn;
            const msgId = msg._id || 'temp-' + Date.now(); 

            if (content.startsWith('data:image')) method = 'steganography';

            if (isMe && method === 'rsa') {
                const cached = getFromLocalCache(content);
                if(cached) { content = cached; msg.originalText = cached; } 
                else if (msg.originalText) { content = msg.originalText; }
            } else if (isMe && msg.originalText) {
                content = msg.originalText;
            }

            const div = document.createElement('div');
            div.id = `msg-${msgId}`; 
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} msg-enter`;
            if (isBurn) div.dataset.burn = "true";

            const color = isBurn ? 'border-red-500/50 text-red-200' : 'border-gray-800 text-gray-300';
            const bg = isMe ? 'bg-white/5' : 'bg-black/40';

            let innerHTML = "";

            if (method === 'steganography') {
                innerHTML = `
                    <div class="mb-2"><img src="${content}" class="max-w-[200px] rounded border border-gray-700"></div>
                    <button onclick="scanImage('${msgId}', '${content}')" class="w-full bg-white/5 hover:bg-[var(--accent)] hover:text-black border border-[var(--accent)] text-[var(--accent)] text-[10px] py-1 rounded transition-all font-bold tracking-widest flex items-center justify-center gap-2">
                        <span>üîç SCAN</span>
                    </button>
                    <div id="plain-${msgId}" class="hidden text-xs font-mono text-green-400 break-all mt-2 border-t border-white/10 pt-2"></div>
                `;
            } 
            else if (method === 'rsa') {
                let isLocked = (!isMe && !getFromLocalCache(msg.text) && !msg.originalText);
                if (isMe) {
                    const cached = getFromLocalCache(content) || msg.originalText;
                    if(cached) { content = cached; isLocked = false; } else { isLocked = true; }
                }

                if (isLocked) {
                    innerHTML = `
                        <div class="encrypted-text mb-2 break-all" id="cipher-${msgId}">${content.substring(0, 20)}...[ENCRYPTED]</div>
                        <button onclick="unlockMessage('${msgId}', '${content}')" class="w-full bg-white/5 hover:bg-[var(--primary)] hover:text-black border border-white/20 text-[var(--primary)] text-[10px] py-1 rounded transition-all font-bold tracking-widest flex items-center justify-center gap-2">
                            <span>üîì UNLOCK</span>
                        </button>
                        <div id="plain-${msgId}" class="hidden text-xs font-mono text-green-400 break-all mt-2 border-t border-white/10 pt-2"></div>
                    `;
                } else {
                    innerHTML = `<div class="text-xs font-mono break-all">${content}</div>`;
                }
            } else {
                innerHTML = `<div class="text-xs font-mono break-all">${content}</div>`;
            }

            const clickAction = (method === 'caesar' && !isMe) ? `onclick="const k=prompt('Shift Key?'); if(k) this.innerText=decryptCaesar(this.innerText, k)"` : '';

            div.innerHTML = `
                <div class="max-w-[85%] rounded-lg p-3 border ${color} ${bg} shadow-lg relative" ${clickAction}>
                    <div class="text-[9px] mb-1 opacity-50 flex justify-between gap-4">
                        <span>${isMe ? 'YOU' : (currentReceiver ? currentReceiver.username : 'Partner')}</span>
                        <span>${isBurn ? 'üî• 10s' : new Date().toLocaleTimeString()}</span>
                    </div>
                    ${innerHTML}
                    ${method !== 'plain' ? `<div class="mt-1 pt-1 border-t border-white/5 text-[9px] text-[var(--accent)] font-bold uppercase">üîí ${method}</div>` : ''}
                </div>
            `;
            
            area.appendChild(div);
            setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);

            if (isBurn && !isMe && method !== 'rsa' && method !== 'steganography') {
                socket.emit("message_seen", msgId);
            }
        }
        
        function scanImage(id, imgSrc) {
            const img = new Image();
            img.onload = () => {
                const cvs = document.getElementById('procCanvas');
                const ctx = cvs.getContext('2d');
                cvs.width = img.width; cvs.height = img.height;
                ctx.drawImage(img, 0, 0);
                const data = ctx.getImageData(0,0,img.width,img.height).data;
                
                let bin = "", res = "";
                for(let i=0; i<data.length; i++) {
                    if(i%4===3) continue;
                    bin += (data[i]&1).toString();
                    if(bin.length===8) {
                        if(bin==="00000000") break;
                        res += String.fromCharCode(parseInt(bin, 2));
                        bin = "";
                    }
                }
                
                document.getElementById(`plain-${id}`).innerText = "HIDDEN MSG: " + res;
                document.getElementById(`plain-${id}`).classList.remove('hidden');
                SoundFX.decrypt();

                const container = document.getElementById(`msg-${id}`);
                if (container && container.dataset.burn === "true") {
                    socket.emit("message_seen", id);
                }
            };
            img.src = imgSrc;
        }

        function unlockMessage(id, cipherText) {
            try {
                const myPriv = localStorage.getItem('rsa_priv');
                const decryptor = new JSEncrypt();
                decryptor.setPrivateKey(myPriv);
                const decrypted = decryptor.decrypt(cipherText);
                
                if (decrypted) {
                    SoundFX.decrypt();
                    document.getElementById(`plain-${id}`).innerText = decrypted;
                    document.getElementById(`plain-${id}`).classList.remove('hidden');
                    document.getElementById(`cipher-${id}`).classList.add('hidden');
                    
                    const container = document.getElementById(`msg-${id}`); 
                    if (container && container.dataset.burn === "true") {
                        socket.emit("message_seen", id);
                    }
                } else { alert("Decryption Failed."); }
            } catch(e) { alert("Decryption Error"); }
        }

        function toggleSpyTools() {
            const el = document.getElementById('spyTools');
            if(el.classList.contains('h-0')) {
                el.classList.remove('h-0'); el.classList.add('h-24');
                document.getElementById('toolArrow').innerText = '‚ñ≤';
            } else {
                el.classList.add('h-0'); el.classList.remove('h-24');
                document.getElementById('toolArrow').innerText = '‚ñº';
            }
        }
        function decryptCaesar(text, shift) {
             const s = (26 - parseInt(shift)) % 26;
             return text.replace(/[a-zA-Z]/g, c => {
                const b = c >= 'a' ? 97 : 65;
                return String.fromCharCode(((c.charCodeAt(0) - b + s) % 26) + b);
            });
        }
        async function loadHistory(partnerId) {
            try {
                const res = await fetch(`/api/messages/${myId}/${partnerId}`);
                const msgs = await res.json();
                msgs.forEach(displayMessage);
            } catch(e) {}
        }
        socket.on('connect', () => {
            socket.emit("login", myId);
            document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            document.getElementById('statusText').innerText = "ONLINE";
            document.getElementById('statusText').className = "text-green-500";
        });
        socket.on('get_users', (onlineIds) => {
            document.querySelectorAll('.status-text').forEach(el => {
                const uid = el.getAttribute('data-id');
                if(onlineIds.includes(uid)) {
                    if (!el.innerText.includes("MSG")) { el.innerText = "ONLINE"; el.classList.replace('text-gray-600', 'text-[var(--primary)]'); }
                } else { el.innerText = "OFFLINE"; el.classList.replace('text-[var(--primary)]', 'text-gray-600'); }
            });
        });
    </script>
</body>
</html>