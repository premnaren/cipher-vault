<!DOCTYPE html>
<html lang="en" data-theme="void">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cipher Vault | Secure Channel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600&display=swap');
        
        :root { --bg-body: #050508; --bg-panel: #0f1015; --primary: #00f3ff; --accent: #bc13fe; --border: #1e293b; }
        
        body { 
            background-color: var(--bg-body); color: #e2e8f0; font-family: 'Inter', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 30px 30px; 
        }
        
        .orbitron { font-family: 'Orbitron', sans-serif; } 
        .mono { font-family: 'Space Mono', monospace; }
        
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; } 
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .active-user { border-left: 2px solid var(--primary); background: rgba(0, 243, 255, 0.05); }
        .msg-enter { animation: slideIn 0.2s ease-out forwards; } 
        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .burn-anim { animation: burnOut 1.5s forwards; }
        @keyframes burnOut { 0% { opacity: 1; filter: blur(0); } 100% { opacity: 0; filter: blur(10px); transform: scale(0.9); } }

        .encrypted-text { color: #bc13fe; font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: -0.5px; opacity: 0.7; }
        
        #spyTools { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #spyTools.open { max-height: 200px; opacity: 1; margin-bottom: 10px; }
    </style>
</head>
<body>

    <nav class="h-16 flex-none border-b border-[var(--border)] bg-[var(--bg-panel)] flex items-center justify-between px-6 z-20">
        <div class="flex items-center gap-4">
            <a href="/" class="text-[var(--primary)] border border-[var(--primary)] px-4 py-1 rounded text-xs font-bold hover:bg-[var(--primary)] hover:text-black transition">‚Üê TERMINAL</a>
            <h1 class="orbitron text-lg font-bold tracking-widest text-white hidden md:block">SECURE <span class="text-[var(--primary)]">UPLINK</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="statusIndicator" class="flex items-center gap-2 text-[10px] font-mono text-gray-500 uppercase">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="statusDot"></span>
                <span id="statusText">OFFLINE</span>
            </div>
            <button onclick="SoundFX.toggle()" id="muteBtn" class="text-gray-500 hover:text-white text-xs border border-gray-700 px-3 py-1 rounded">üîä ON</button>
            <button onclick="logout()" class="text-red-500 hover:text-white text-xs border border-red-900 px-3 py-1 rounded">LOGOUT</button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 border-r border-[var(--border)] bg-[var(--bg-panel)] flex flex-col z-10 hidden md:flex">
            <div class="p-4 border-b border-[var(--border)]">
                <label for="userSearch" class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 block">ACTIVE AGENTS</label>
                <input type="text" id="userSearch" title="Search Users" aria-label="Search Agents" placeholder="SEARCH ID..." class="w-full bg-black border border-[var(--border)] text-xs text-white p-2 rounded outline-none focus:border-[var(--primary)]">
            </div>
            <div id="usersList" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center text-[10px] text-gray-600 mt-10 mono">SCANNING NETWORK...</div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-black/20">
            
            <div id="chatHeader" class="h-12 border-b border-[var(--border)] flex items-center px-4 justify-between bg-[var(--bg-panel)] hidden">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 rounded-full bg-[var(--primary)] shadow-[0_0_10px_var(--primary)]"></div>
                    <div>
                        <div class="text-xs font-bold text-white orbitron tracking-wide" id="chatPartnerName">Unknown</div>
                        <div class="text-[9px] mono text-gray-500" id="encryptionStatus">UNSECURED</div>
                    </div>
                </div>
            </div>

            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600">
                <div class="text-4xl mb-2 opacity-20">üì°</div>
                <p class="mono text-xs tracking-widest">SELECT AN AGENT TO BEGIN</p>
                <p class="mono text-[10px] text-green-500 mt-2" id="keyGenStatus">INITIALIZING ENGINES...</p>
            </div>

            <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-4 hidden pb-20"></div>

            <div id="inputArea" class="p-4 border-t border-[var(--border)] bg-[var(--bg-panel)] hidden">
                <div class="max-w-4xl mx-auto relative">
                    
                    <button onclick="toggleSpyTools()" class="absolute -top-10 right-0 bg-[var(--bg-panel)] border border-[var(--border)] border-b-0 text-[var(--primary)] px-3 py-1 rounded-t-lg text-[10px] font-bold tracking-widest hover:text-white transition-colors flex items-center gap-2">
                        <span>‚öôÔ∏è ENCRYPTION SETTINGS</span>
                        <span id="toolArrow">‚ñº</span>
                    </button>

                    <div id="spyTools" class="bg-black/50 border border-[var(--border)] rounded-lg p-3 mb-2">
                        <div class="flex flex-col md:flex-row gap-3">
                            <div class="flex-1">
                                <label for="cipherMethod" class="text-[9px] text-[var(--primary)] font-bold block mb-1">PROTOCOL</label>
                                <select id="cipherMethod" title="Select Encryption Protocol" aria-label="Encryption Protocol" class="w-full bg-[#050508] border border-[var(--border)] text-[10px] text-gray-300 p-2 rounded focus:border-[var(--primary)] outline-none font-mono uppercase">
                                    <option value="rsa" selected>1. RSA (MILITARY GRADE)</option>
                                    <option value="caesar">2. CAESAR (BASIC)</option>
                                    <option value="plain">3. PLAINTEXT (NONE)</option>
                                </select>
                            </div>

                            <div class="flex-[1.5]" id="cipherKeyContainer">
                                <label for="cipherKey" class="text-[9px] text-[var(--accent)] font-bold block mb-1">MANUAL KEY (NON-RSA)</label>
                                <input id="cipherKey" title="Manual Key" aria-label="Secret Key" type="text" placeholder="Not needed for RSA" class="w-full bg-[#050508] border border-[var(--border)] text-[10px] text-gray-500 p-2 rounded focus:border-[var(--accent)] outline-none font-mono">
                            </div>

                            <div class="flex items-end">
                                <label class="flex items-center gap-2 cursor-pointer border border-red-900/50 bg-red-900/10 px-3 py-2 rounded hover:bg-red-900/20 h-[34px]">
                                    <input type="checkbox" id="burnCheck" title="Toggle Burn on Read" aria-label="Burn on Read" class="accent-red-500 w-3 h-3">
                                    <span class="text-[9px] text-red-500 font-bold orbitron">BURN</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <form id="chatForm" class="flex gap-2 items-center">
                        <div class="w-8 h-8 rounded-full bg-[var(--border)] flex items-center justify-center text-gray-500 text-xs" id="lockIcon">üîí</div>
                        <input id="msgInput" title="Message Input" aria-label="Type your message" placeholder="Type a secure message..." autocomplete="off" class="flex-grow bg-black border border-[var(--border)] p-3 rounded text-sm text-white focus:border-[var(--primary)] outline-none font-mono">
                        <button type="submit" class="bg-[var(--primary)] text-black px-6 py-3 rounded font-bold orbitron hover:shadow-[0_0_15px_rgba(0,243,255,0.3)] transition-all text-xs">SEND</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 0. SOUND SYSTEM (WEB AUDIO API) ---
        const SoundFX = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            muted: false,
            
            toggle: function() {
                this.muted = !this.muted;
                document.getElementById('muteBtn').innerText = this.muted ? "üîá OFF" : "üîä ON";
                // Resume context if suspended (browser autoplay policy)
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },

            playOscillator: function(freq, type, duration, vol=0.1) {
                if(this.muted) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playWhiteNoise: function(duration) {
                if(this.muted) return;
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                noise.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },

            send: function() { this.playOscillator(1200, 'sine', 0.1); }, // High blip
            receive: function() { 
                this.playOscillator(800, 'square', 0.1); 
                setTimeout(() => this.playOscillator(1200, 'square', 0.2), 100);
            },
            decrypt: function() {
                this.playOscillator(200, 'sawtooth', 0.5);
                setTimeout(() => this.playOscillator(600, 'sine', 0.3), 100);
            },
            burn: function() { this.playWhiteNoise(0.5); } // Fizzle sound
        };

        // --- UI LOGIC ---
        function toggleSpyTools() {
            const el = document.getElementById('spyTools');
            el.classList.toggle('open');
            document.getElementById('toolArrow').innerText = el.classList.contains('open') ? '‚ñ≤' : '‚ñº';
        }

        const token = localStorage.getItem('auth-token');
        if (!token) window.location.href = '/login.html';
        
        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        
        const userPayload = parseJwt(token);
        const userData = userPayload.user || userPayload;
        const myId = userData._id || userData.id; 

        if (!myId) {
            localStorage.removeItem('auth-token');
            window.location.href = '/login.html';
        }

        const socket = io({ auth: { token } });
        let currentReceiver = null;
        let activeUsersMap = {}; 
        const myRSA = new JSEncrypt({ default_key_size: 1024 });
        
        function saveToLocalCache(cipher, plain) {
            try {
                let cache = JSON.parse(localStorage.getItem('sent_cache') || '{}');
                cache[cipher] = plain;
                localStorage.setItem('sent_cache', JSON.stringify(cache));
            } catch(e) {}
        }
        
        function getFromLocalCache(cipher) {
            try {
                let cache = JSON.parse(localStorage.getItem('sent_cache') || '{}');
                return cache[cipher];
            } catch(e) { return null; }
        }

        async function initIdentity() {
            let storedPriv = localStorage.getItem('rsa_priv');
            let storedPub = localStorage.getItem('rsa_pub');

            if(!storedPriv || !storedPub) {
                document.getElementById('keyGenStatus').innerText = "GENERATING NEW IDENTITY...";
                myRSA.getKey();
                storedPriv = myRSA.getPrivateKey();
                storedPub = myRSA.getPublicKey();
                localStorage.setItem('rsa_priv', storedPriv);
                localStorage.setItem('rsa_pub', storedPub);
            }
            
            myRSA.setPrivateKey(storedPriv);
            
            try {
                await fetch('/api/users/key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: myId, publicKey: storedPub })
                });
                document.getElementById('keyGenStatus').innerText = "IDENTITY SECURED & SYNCED.";
                document.getElementById('keyGenStatus').className = "mono text-[10px] text-[var(--primary)] mt-2";
            } catch(e) { console.error("Key Sync Failed", e); }
        }
        setTimeout(initIdentity, 100);

        function logout() { localStorage.removeItem('auth-token'); window.location.href = '/login.html'; }

        async function selectUser(user, el) {
            currentReceiver = user;
            document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active-user'));
            el.classList.add('active-user');
            
            const statusText = el.querySelector('.status-text');
            if(statusText.innerText.includes("MSG")) statusText.innerText = "ONLINE";

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('messagesArea').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            document.getElementById('chatPartnerName').innerText = user.username;
            
            try {
                const res = await fetch('/api/users');
                const freshUsers = await res.json();
                const freshUser = freshUsers.find(u => u._id === user._id);
                if (freshUser) activeUsersMap[user._id] = freshUser;
                
                const statusEl = document.getElementById('encryptionStatus');
                if(freshUser && freshUser.publicKey && freshUser.publicKey.includes("BEGIN PUBLIC KEY")) {
                    statusEl.innerText = "üîí SECURE UPLINK ESTABLISHED";
                    statusEl.className = "text-[9px] mono text-[var(--primary)]";
                } else {
                    statusEl.innerText = "‚ö†Ô∏è UNSECURED (PARTNER NEEDS TO RE-LOGIN)";
                    statusEl.className = "text-[9px] mono text-red-500 animate-pulse";
                }
            } catch(e) {}

            document.getElementById('messagesArea').innerHTML = ''; 
            loadHistory(user._id);
        }

        async function fetchUsers() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                const list = document.getElementById('usersList');
                list.innerHTML = '';
                
                users.forEach(u => {
                    if (u._id === myId) return; 
                    activeUsersMap[u._id] = u;

                    const div = document.createElement('div');
                    div.className = 'user-card p-3 cursor-pointer hover:bg-white/5 flex items-center gap-3 border-l-2 border-transparent transition-all';
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center text-[var(--primary)] font-bold text-xs orbitron">${u.username.substring(0,2).toUpperCase()}</div>
                        <div>
                            <div class="text-sm font-bold text-gray-300">${u.username}</div>
                            <div class="text-[9px] text-gray-600 mono status-text" data-id="${u._id}">OFFLINE</div>
                        </div>
                    `;
                    div.onclick = () => selectUser(u, div);
                    list.appendChild(div);
                });
            } catch(e) { console.error("User Fetch Error", e); }
        }
        fetchUsers();

        function sendMessage(text, forcedMethod = null, isBurn = false) {
            if(!currentReceiver) return alert("Select a user first!");
            const method = forcedMethod || document.getElementById('cipherMethod').value;
            let cipherText = text;

            if (method === 'rsa') {
                const partnerData = activeUsersMap[currentReceiver._id];
                if (!partnerData || !partnerData.publicKey) {
                    return alert("User key missing. Ask them to login.");
                }
                const encryptor = new JSEncrypt();
                encryptor.setPublicKey(partnerData.publicKey);
                cipherText = encryptor.encrypt(text);
                if(!cipherText) return alert("Message too long for RSA.");
                
                saveToLocalCache(cipherText, text);
            } 
            else if (method === 'caesar') {
                const shift = parseInt(document.getElementById('cipherKey').value) || 3;
                cipherText = text.replace(/[a-zA-Z]/g, c => {
                    const b = c >= 'a' ? 97 : 65;
                    return String.fromCharCode(((c.charCodeAt(0) - b + shift) % 26) + b);
                });
            }

            const payload = {
                senderId: myId,
                receiverId: currentReceiver._id,
                text: cipherText,
                cipherType: method,
                isBurn: isBurn,
                timestamp: new Date()
            };

            socket.emit("private_message", payload);
            SoundFX.send(); // SOUND EFFECT
            // displayMessage is handled by socket echo to ensure sync
        }

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            const burn = document.getElementById('burnCheck').checked;
            if(!input.value) return;
            sendMessage(input.value, null, burn);
            input.value = '';
            document.getElementById('burnCheck').checked = false;
        });

        socket.on("receive_message", (data) => {
            const senderString = String(data.senderId || data.sender);
            const activeReceiverString = currentReceiver ? String(currentReceiver._id) : null;

            if (activeReceiverString && (senderString === activeReceiverString || senderString === String(myId))) {
                displayMessage(data);
                if (senderString !== String(myId)) SoundFX.receive(); // SOUND EFFECT FOR RECEIVING
            } else if (senderString !== String(myId)) {
                SoundFX.receive(); // SOUND EFFECT FOR NOTIFICATION
                const userStatus = document.querySelector(`.status-text[data-id="${senderString}"]`);
                if(userStatus) {
                    userStatus.innerText = "üì© NEW MSG";
                    userStatus.classList.add('text-[var(--primary)]', 'animate-pulse');
                }
            }
        });

        socket.on("message_burnt", (msgId) => {
            const el = document.getElementById(`msg-${msgId}`);
            if(el) {
                SoundFX.burn(); // SOUND EFFECT
                el.classList.add('burn-anim');
                setTimeout(() => el.remove(), 1500);
            }
        });

        function displayMessage(msg) {
            const area = document.getElementById('messagesArea');
            const senderString = String(msg.sender || msg.senderId);
            const isMe = (senderString === String(myId));
            
            let content = msg.text || msg.cipherText;
            const method = msg.cipherType || 'plain';
            const isBurn = msg.isBurn;
            const msgId = msg._id; 

            if (isMe && method === 'rsa') {
                const cached = getFromLocalCache(content);
                if(cached) { content = cached; msg.originalText = cached; } 
                else if (msg.originalText) { content = msg.originalText; }
            } else if (isMe && msg.originalText) {
                content = msg.originalText;
            }

            const div = document.createElement('div');
            div.id = `msg-${msgId}`; 
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} msg-enter`;
            
            if (isBurn) div.dataset.burn = "true";

            const color = isBurn ? 'border-red-500/50 text-red-200' : 'border-gray-800 text-gray-300';
            const bg = isMe ? 'bg-white/5' : 'bg-black/40';

            let isLocked = (!isMe && method === 'rsa');
            if(isMe && method === 'rsa' && !getFromLocalCache(msg.text) && !msg.originalText) isLocked = true;

            let contentHtml = `<div class="text-xs font-mono break-all">${content}</div>`;
            
            if (isLocked) {
                contentHtml = `
                    <div class="encrypted-text mb-2 break-all" id="cipher-${msgId}">${content.substring(0, 20)}...[ENCRYPTED]</div>
                    <button onclick="unlockMessage('${msgId}', '${content}')" class="w-full bg-white/5 hover:bg-[var(--primary)] hover:text-black border border-white/20 text-[var(--primary)] text-[10px] py-1 rounded transition-all font-bold tracking-widest flex items-center justify-center gap-2">
                        <span>üîì UNLOCK DATA</span>
                    </button>
                    <div id="plain-${msgId}" class="hidden text-xs font-mono text-green-400 break-all mt-2 border-t border-white/10 pt-2"></div>
                `;
            }

            const clickAction = (method === 'caesar' && !isMe) ? `onclick="const k=prompt('Shift Key?'); if(k) this.innerText=decryptCaesar(this.innerText, k)"` : '';

            div.innerHTML = `
                <div class="max-w-[75%] rounded-lg p-3 border ${color} ${bg} shadow-lg relative" ${clickAction}>
                    <div class="text-[9px] mb-1 opacity-50 flex justify-between gap-4">
                        <span>${isMe ? 'YOU' : currentReceiver.username}</span>
                        <span>${isBurn ? 'üî• 10s' : new Date().toLocaleTimeString()}</span>
                    </div>
                    ${contentHtml}
                    ${method !== 'plain' ? `<div class="mt-1 pt-1 border-t border-white/5 text-[9px] text-[var(--accent)] font-bold uppercase">üîí ${method}</div>` : ''}
                </div>
            `;
            
            area.appendChild(div);
            setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);

            // LOGIC: TRIGGER BURN FOR UNLOCKED MESSAGES
            if (isBurn && !isMe && !isLocked) {
                socket.emit("message_seen", msgId);
            }
        }
        
        function unlockMessage(id, cipherText) {
            try {
                const myPriv = localStorage.getItem('rsa_priv');
                const decryptor = new JSEncrypt();
                decryptor.setPrivateKey(myPriv);
                const decrypted = decryptor.decrypt(cipherText);
                
                if (decrypted) {
                    SoundFX.decrypt(); // SOUND EFFECT
                    document.getElementById(`plain-${id}`).innerText = decrypted;
                    document.getElementById(`plain-${id}`).classList.remove('hidden');
                    document.getElementById(`cipher-${id}`).classList.add('hidden');
                    
                    const container = document.getElementById(`msg-${id}`); 
                    const btn = container ? container.getElementsByTagName('button')[0] : null;
                    if(btn) btn.classList.add('hidden');

                    if (container && container.dataset.burn === "true") {
                        console.log("üî• Triggering Burn for RSA message", id);
                        socket.emit("message_seen", id);
                    }

                } else {
                    alert("Decryption Failed.");
                }
            } catch(e) { console.error(e); alert("Decryption Error"); }
        }

        function decryptCaesar(text, shift) {
             const s = (26 - parseInt(shift)) % 26;
             return text.replace(/[a-zA-Z]/g, c => {
                const b = c >= 'a' ? 97 : 65;
                return String.fromCharCode(((c.charCodeAt(0) - b + s) % 26) + b);
            });
        }

        async function loadHistory(partnerId) {
            try {
                const res = await fetch(`/api/messages/${myId}/${partnerId}`);
                const msgs = await res.json();
                msgs.forEach(displayMessage);
            } catch(e) {}
        }

        socket.on('connect', () => {
            socket.emit("login", myId);
            document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            document.getElementById('statusText').innerText = "ONLINE";
            document.getElementById('statusText').className = "text-green-500";
        });
        
        socket.on('get_users', (onlineIds) => {
            document.querySelectorAll('.status-text').forEach(el => {
                const uid = el.getAttribute('data-id');
                if(onlineIds.includes(uid)) {
                    if (!el.innerText.includes("MSG")) {
                        el.innerText = "ONLINE"; 
                        el.classList.replace('text-gray-600', 'text-[var(--primary)]');
                    }
                } else {
                    el.innerText = "OFFLINE"; el.classList.replace('text-[var(--primary)]', 'text-gray-600');
                }
            });
        });
    </script>
</body>
</html>